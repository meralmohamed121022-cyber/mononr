<!DOCTYPE html>
<html lang="en">
<head>
    <html lang="en-GB">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONO - Mono Wasfaty System</title>
    <title>WASFATYREFILL-MONO</title>
<link rel="icon" href="https://raw.githubusercontent.com/meralmohamed121022-cyber/Drug-Monograph/858ba78ce2719a0e7069fd4807b725e0002a17d8/6_20251129_184528_0005.png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/meralmohamed121022-cyber/Drug-Monograph/858ba78ce2719a0e7069fd4807b725e0002a17d8/6_20251129_184528_0005.png">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
      :root {
    /* تم تغيير اللون للأزرق الغامق */
    --primary: #0d47a1;       /* أزرق غامق أساسي */
    --primary-dark: #002171;  /* درجة أغمق للظل والضغط */
    
    --secondary: #00B894;
    --danger: #c0392b;        /* تم تغميق الأحمر قليلاً ليتماشى مع الأزرق */
    --warning: #FFA502;
    --info: #1976D2;
    --light: #F8F9FE;
    --dark: #2D3436;
    --border: #DFE6E9;
    --shadow: rgba(13, 71, 161, 0.2); /* تعديل لون الظل للأزرق */
}
        /* ستايل لتمييز النص عند البحث */
.highlight-text {
    background-color: #ffe082; /* لون أصفر */
    color: black;
    font-weight: bold;
    padding: 0 2px;
    border-radius: 2px;
}
      body {
    font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    /* خلفية زرقاء غامقة متدرجة */
    background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(108, 92, 231, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 107, 107, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* ============================================ */
        /* CSS ART ICONS */
        /* ============================================ */
        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            position: relative;
            vertical-align: middle;
            margin-right: 8px;
        }
        
        /* Icon: User/Patient */
        .icon-user {
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            position: relative;
        }
        .icon-user::before {
            content: '';
            position: absolute;
            width: 30px;
            height: 20px;
            background: var(--primary);
            border-radius: 50% 50% 0 0;
            bottom: -12px;
            left: -5px;
        }
        
        /* Icon: Add/Plus */
        .icon-add {
            width: 24px;
            height: 24px;
            position: relative;
        }
        .icon-add::before,
        .icon-add::after {
            content: '';
            position: absolute;
            background: currentColor;
        }
        .icon-add::before {
            width: 20px;
            height: 3px;
            top: 50%;
            left: 2px;
            transform: translateY(-50%);
        }
        .icon-add::after {
            width: 3px;
            height: 20px;
            left: 50%;
            top: 2px;
            transform: translateX(-50%);
        }
        
        /* Icon: Save/Disk */
        .icon-save {
            width: 20px;
            height: 22px;
            border: 3px solid currentColor;
            border-radius: 2px;
            position: relative;
        }
        .icon-save::before {
            content: '';
            position: absolute;
            width: 14px;
            height: 3px;
            background: currentColor;
            bottom: 0;
            left: 0;
        }
        .icon-save::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            border: 2px solid currentColor;
            top: -3px;
            right: -3px;
            background: white;
        }
        
        /* Icon: Edit/Pencil */
        .icon-edit {
            width: 18px;
            height: 18px;
            border-right: 3px solid currentColor;
            border-bottom: 3px solid currentColor;
            transform: rotate(-45deg);
            position: relative;
        }
        .icon-edit::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 3px;
            background: currentColor;
            top: -8px;
            right: -5px;
            transform: rotate(45deg);
        }
        
        /* Icon: Delete/Trash */
        .icon-delete {
            width: 16px;
            height: 18px;
            border: 3px solid currentColor;
            border-top: 0;
            border-radius: 0 0 3px 3px;
            position: relative;
        }
        .icon-delete::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 3px;
            background: currentColor;
            top: -6px;
            left: -5px;
        }
        .icon-delete::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 2px;
            background: currentColor;
            top: -10px;
            left: 0px;
            border-radius: 2px 2px 0 0;
        }
        
        /* Icon: WhatsApp */
        .icon-whatsapp {
            width: 20px;
            height: 20px;
            border: 3px solid currentColor;
            border-radius: 50%;
            position: relative;
        }
        .icon-whatsapp::before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            border: 2px solid currentColor;
            border-radius: 50%;
            top: 4px;
            left: 4px;
        }
        .icon-whatsapp::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            border-right: 3px solid currentColor;
            border-bottom: 3px solid currentColor;
            bottom: -4px;
            right: 2px;
            transform: rotate(45deg);
        }
        
        /* Icon: Download/Export */
        .icon-download {
            width: 18px;
            height: 18px;
            position: relative;
        }
        .icon-download::before {
            content: '';
            position: absolute;
            width: 3px;
            height: 12px;
            background: currentColor;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        .icon-download::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border-right: 3px solid currentColor;
            border-bottom: 3px solid currentColor;
            transform: rotate(45deg);
            bottom: 3px;
            left: 2px;
        }
        
        /* Icon: Upload/Import */
        .icon-upload {
            width: 18px;
            height: 18px;
            position: relative;
        }
        .icon-upload::before {
            content: '';
            position: absolute;
            width: 3px;
            height: 12px;
            background: currentColor;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        .icon-upload::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border-right: 3px solid currentColor;
            border-bottom: 3px solid currentColor;
            transform: rotate(-135deg);
            top: 0;
            left: 2px;
        }
        
        /* Icon: Calendar */
        .icon-calendar {
            width: 18px;
            height: 20px;
            border: 3px solid currentColor;
            border-radius: 2px;
            position: relative;
        }
        .icon-calendar::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 3px;
            background: currentColor;
            top: 4px;
            left: 0;
        }
        .icon-calendar::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 2px;
            background: currentColor;
            top: -5px;
            left: 0;
        }
        
        /* Icon: Search */
        .icon-search {
            width: 14px;
            height: 14px;
            border: 3px solid currentColor;
            border-radius: 50%;
            position: relative;
        }
        .icon-search::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 3px;
            background: currentColor;
            bottom: -6px;
            right: -6px;
            transform: rotate(45deg);
        }
        
        /* Icon: Database */
        .icon-database {
            width: 20px;
            height: 24px;
            position: relative;
        }
        .icon-database::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 6px;
            border: 3px solid currentColor;
            border-radius: 50%;
            top: 0;
        }
        .icon-database::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 18px;
            border-left: 3px solid currentColor;
            border-right: 3px solid currentColor;
            border-bottom: 3px solid currentColor;
            border-radius: 0 0 50% 50%;
            bottom: 0;
        }
        
        /* Icon: Chart/Stats */
        .icon-chart {
            width: 20px;
            height: 20px;
            position: relative;
        }
        .icon-chart::before {
            content: '';
            position: absolute;
            width: 5px;
            height: 15px;
            background: currentColor;
            bottom: 0;
            left: 0;
        }
        .icon-chart::after {
            content: '';
            position: absolute;
            width: 5px;
            height: 20px;
            background: currentColor;
            bottom: 0;
            right: 0;
        }
        .icon-chart > span {
            position: absolute;
            width: 5px;
            height: 10px;
            background: currentColor;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* Icon: Prescription/Pill */
        .icon-pill {
            width: 20px;
            height: 8px;
            background: currentColor;
            border-radius: 10px;
            position: relative;
        }
        .icon-pill::before {
            content: '';
            position: absolute;
            width: 50%;
            height: 100%;
            background: rgba(255,255,255,0.3);
            left: 0;
            border-radius: 10px 0 0 10px;
        }
        
        /* Icon: Logout */
        .icon-logout {
            width: 20px;
            height: 16px;
            border: 3px solid currentColor;
            border-right: 0;
            border-radius: 5px 0 0 5px;
            position: relative;
        }
        .icon-logout::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 3px;
            background: currentColor;
            top: 50%;
            right: -10px;
            transform: translateY(-50%);
        }
        .icon-logout::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            border-top: 3px solid currentColor;
            border-right: 3px solid currentColor;
            transform: rotate(45deg);
            top: 3px;
            right: -13px;
        }
        
        /* ============================================ */
        /* MODAL STYLES */
        /* ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-box {
            background: white;
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            position: relative;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(50px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--light);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: var(--dark);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }
        
        .modal-content {
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* Duplicate Cards in Modal */
        .duplicate-card {
            background: linear-gradient(135deg, #F8F9FE, #E3E8FF);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .duplicate-card .card-id {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .duplicate-card .card-prescriptions {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .duplicate-card .presc-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            margin: 3px;
            font-size: 11px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }
        
        .duplicate-card .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }
        
        .duplicate-card .qr-mini {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .duplicate-card .qr-mini-box {
            text-align: center;
        }
        
        .duplicate-card .qr-mini-box img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            border: 2px solid var(--border);
        }
        
        .duplicate-card .qr-mini-box .qr-mini-label {
            font-size: 9px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 5px;
        }
        
        /* ============================================ */
        /* EXISTING STYLES (OPTIMIZED) */
        /* ============================================ */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-box {
            background: white;
            padding: 50px 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            position: relative;
            z-index: 1;
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .auth-logo h1 {
            font-size: 3em;
            font-weight: 700;
            letter-spacing: 12px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .auth-logo p {
            font-size: 0.9em;
            color: #636E72;
            margin-top: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .auth-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #F8F9FE;
            padding: 5px;
            border-radius: 12px;
        }
        
        .auth-toggle button {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #636E72;
        }
        
        .auth-toggle button.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
      .header {
    /* خلفية الهيدر أزرق غامق */
    background: linear-gradient(135deg, rgba(13, 71, 161, 0.95) 0%, rgba(0, 33, 113, 0.95) 100%);
    backdrop-filter: blur(10px);
    color: white;
    padding: 25px 20px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    position: relative;
    z-index: 10;
}
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #00B894, #54A0FF, #FFA502);
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: 12px;
            margin-bottom: 8px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 0.85em;
            opacity: 0.95;
            font-weight: 500;
            letter-spacing: 3px;
        }
        
        .header .logout-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .header .logout-btn:hover {
            background: white;
            color: var(--primary);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 100px);
            position: relative;
            z-index: 1;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .nav-tab {
            flex: 1;
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: white;
            color: #95A5A6;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 3px solid transparent;
            position: relative;
        }
        
        .nav-tab::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 80%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--info));
            transition: transform 0.3s ease;
            border-radius: 3px 3px 0 0;
        }
        
        .nav-tab:hover {
            color: var(--primary);
            background: #F8F9FE;
        }
        
        .nav-tab.active {
            color: var(--primary);
            background: linear-gradient(180deg, #F8F9FE 0%, white 100%);
        }
        
        .nav-tab.active::before {
            transform: translateX(-50%) scaleX(1);
        }
        
        .tab-content {
            display: none;
            padding: 25px 20px;
            animation: fadeInUp 0.4s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: #636E72;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        
        .form-input {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1);
            transform: translateY(-2px);
        }
        
        .form-input::placeholder {
            color: #B2BEC3;
        }
        
        .refill-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .refill-box {
            padding: 22px 12px;
            border: 2px solid var(--border);
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .refill-box:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }
        
        .refill-box.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--info));
            color: white;
            transform: translateY(-4px);
            box-shadow: 0 12px 32px var(--shadow);
        }
        
        .refill-box .duration {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .refill-box .label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .section-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            margin: 30px 0 18px 0;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, var(--primary), var(--info));
            border-radius: 4px;
        }
        
        .prescription-item {
            background: linear-gradient(135deg, #F8F9FE 0%, #F0F3FF 100%);
            border: 2px solid #E3E8FF;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .prescription-item:hover {
            box-shadow: 0 8px 24px rgba(108, 92, 231, 0.15);
            transform: translateY(-2px);
        }
        
        .prescription-item .remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #FF6B6B, #EE5A6F);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .prescription-item .remove-btn:hover {
            transform: scale(1.1) rotate(90deg);
        }
        
        .add-prescription-btn {
            width: 100%;
            padding: 15px;
            background: white;
            border: 2px dashed var(--primary);
            border-radius: 12px;
            color: var(--primary);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .add-prescription-btn:hover {
            background: #F8F9FE;
            border-style: solid;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }
        
        .btn-primary {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            box-shadow: 0 8px 24px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 36px rgba(108, 92, 231, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            width: 100%;
            padding: 18px;
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-secondary:hover {
            background: #F8F9FE;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }
        
        .btn-import {
            width: 100%;
            padding: 16px;
            background: white;
            color: var(--warning);
            border: 2px solid var(--warning);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-import:hover {
            background: linear-gradient(135deg, var(--warning), #FF8C00);
            color: white;
            border-color: var(--warning);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 165, 2, 0.3);
        }
        
        .qr-display {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #F0F3FF;
        }
        
        .qr-box {
            background: white;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #E3E8FF;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .qr-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(108, 92, 231, 0.2);
        }
        
        .qr-box img {
            display: block;
            margin: 0 auto 10px auto;
            border-radius: 8px;
        }
        
        .qr-box .qr-label {
            font-size: 10px;
            color: var(--primary);
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }
        
        .qr-box .qr-value {
            font-size: 13px;
            color: var(--dark);
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            padding: 24px 16px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--info));
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
        }
        
        .stat-card.total {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card.today {
            background: linear-gradient(135deg, #00B894 0%, #00D2A0 100%);
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(0, 184, 148, 0.3);
        }
        
        .stat-card.upcoming {
            background: linear-gradient(135deg, #FFA502 0%, #FF8C00 100%);
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(255, 165, 2, 0.3);
        }
        
        .stat-card.overdue {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(255, 107, 107, 0.3);
        }
        
        .stat-card .number {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .stat-card .label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            opacity: 0.95;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1);
        }
        
        .search-icon-wrapper {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #B2BEC3;
        }
        
        .date-filter {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .date-filter input {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .filter-chips {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .chip {
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .chip:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .chip.active {
            background: linear-gradient(135deg, var(--secondary), #00D2A0);
            color: white;
            border-color: var(--secondary);
            box-shadow: 0 4px 16px rgba(0, 184, 148, 0.3);
        }
        
        .patient-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 18px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .patient-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: linear-gradient(180deg, var(--primary), var(--info));
        }
        
        .patient-card:hover {
            box-shadow: 0 12px 36px rgba(0,0,0,0.12);
            transform: translateY(-4px);
        }
        
        .patient-card.today::before {
            background: linear-gradient(180deg, var(--secondary), #00D2A0);
        }
        
        .patient-card.overdue::before {
            background: linear-gradient(180deg, var(--danger), #EE5A6F);
        }
        
        .patient-card.upcoming::before {
            background: linear-gradient(180deg, var(--warning), #FF8C00);
        }
        
        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .patient-id {
            font-size: 20px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 6px;
            font-family: 'Courier New', monospace;
        }
        
        .patient-phone {
            font-size: 14px;
            font-weight: 600;
            color: #636E72;
        }
        
        .patient-badge {
            background: linear-gradient(135deg, var(--primary), var(--info));
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .patient-info {
            font-size: 13px;
            color: #636E72;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .patient-info strong {
            color: var(--dark);
            font-weight: 700;
        }
        
        .prescriptions-list {
            background: #F8F9FE;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
        }
        
        .prescription-tag {
            display: inline-block;
            background: white;
            padding: 8px 14px;
            border-radius: 8px;
            margin: 5px 5px 5px 0;
            font-size: 12px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            border: 2px solid #E3E8FF;
            color: var(--primary);
        }
        
        .patient-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-action {
            padding: 12px 10px;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-edit {
            background: linear-gradient(135deg, var(--info), #3498DB);
            color: white;
            box-shadow: 0 4px 12px rgba(84, 160, 255, 0.3);
        }
        
        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(84, 160, 255, 0.4);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, var(--danger), #EE5A6F);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }
        
        .btn-whatsapp:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }
        
        .export-section {
            background: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 18px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .export-section:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .export-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .btn-export {
            padding: 14px 10px;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-json {
            background: linear-gradient(135deg, var(--secondary), #00D2A0);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);
        }
        
        .btn-excel {
            background: linear-gradient(135deg, var(--info), #3498DB);
            color: white;
            box-shadow: 0 4px 12px rgba(84, 160, 255, 0.3);
        }
        
        .btn-text {
            background: linear-gradient(135deg, var(--warning), #FF8C00);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 165, 2, 0.3);
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        
        .import-area {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF3CC 100%);
            border: 3px dashed var(--warning);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .import-area:hover {
            background: linear-gradient(135deg, #FFF3CC 0%, #FFE9A0 100%);
            border-color: #FF8C00;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(255, 165, 2, 0.2);
        }
        
        .import-icon-wrapper {
            font-size: 56px;
            margin-bottom: 12px;
            animation: float 3s ease-in-out infinite;
            display: inline-block;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .import-text {
            font-size: 15px;
            color: #E67E00;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .no-data {
            text-align: center;
            padding: 80px 20px;
            color: #B2BEC3;
        }
        
        .no-data-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.4;
        }
        
        .date-badge {
            display: inline-block;
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            color: #1976D2;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 10px;
            border: 2px solid #BBDEFB;
        }
        
        .date-badge.today {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            color: #2E7D32;
            border-color: #C8E6C9;
        }
        
        .date-badge.upcoming {
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
            color: #F57C00;
            border-color: #FFE0B2;
        }
        
        .date-badge.overdue {
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
            color: #C62828;
            border-color: #FFCDD2;
            animation: blink 2s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .whatsapp-export-container {
            position: fixed;
            left: -9999px;
            top: 0;
            background: white;
            padding: 30px;
            border-radius: 16px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .info-box {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 13px;
            color: #1565C0;
        }
        
        .info-box strong {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 2em;
                letter-spacing: 8px;
            }
            
            .header .logout-btn {
                position: static;
                transform: none;
                display: block;
                margin-top: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card .number {
                font-size: 28px;
            }
            
            .patient-actions {
                grid-template-columns: 1fr;
            }
        }
        /* ============================================ */
/* SVG BUTTON STYLES WITH TOOLTIPS */
/* ============================================ */
.btn-action {
    position: relative;
    padding: 10px 14px;
    border: none;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    overflow: visible;
}

.btn-action svg {
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.btn-action:hover {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 8px 24px rgba(0,0,0,0.25) !important;
}

.btn-action:active {
    transform: translateY(-1px) scale(0.98) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

/* Edit Button */
.btn-edit {
    background: linear-gradient(135deg, #54A0FF 0%, #3498DB 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(84, 160, 255, 0.3);
}

.btn-edit:hover {
    background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%);
}

.btn-edit:hover svg {
    transform: rotate(-12deg) scale(1.1);
}

.btn-edit:active {
    background: linear-gradient(135deg, #2980B9 0%, #2471A3 100%);
}

/* Delete Button */
.btn-delete {
    background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
}

.btn-delete:hover {
    background: linear-gradient(135deg, #EE5A6F 0%, #E74C3C 100%);
}

.btn-delete:hover svg {
    animation: shake 0.5s ease;
}

.btn-delete:active {
    background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
}

@keyframes shake {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-8deg); }
    50% { transform: rotate(8deg); }
    75% { transform: rotate(-8deg); }
}

/* WhatsApp Button */
.btn-whatsapp {
    background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
}

.btn-whatsapp:hover {
    background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
}

.btn-whatsapp:hover svg {
    animation: bounce 0.6s ease;
}

.btn-whatsapp:active {
    background: linear-gradient(135deg, #075E54 0%, #054D44 100%);
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

/* Tooltip Styles */
.btn-action::before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%) scale(0.8);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    letter-spacing: 0.5px;
}

.btn-action::after {
    content: '';
    position: absolute;
    bottom: calc(100% + 4px);
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.9);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
}

.btn-action:hover::before {
    opacity: 1;
    transform: translateX(-50%) scale(1) translateY(-3px);
}

.btn-action:hover::after {
    opacity: 1;
}

/* Stats Cards Clickable */
.stat-card {
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
}

.stat-card:active {
    transform: translateY(-2px) scale(0.98) !important;
}

/* Primary Button with Icon */
.btn-primary svg,
.btn-secondary svg,
.btn-import svg,
.btn-export svg,
.add-prescription-btn svg {
    transition: transform 0.3s ease;
}

.btn-primary:hover svg,
.btn-secondary:hover svg {
    transform: scale(1.1);
}

.btn-import:hover svg,
.btn-export:hover svg {
    transform: translateY(-2px);
}

.add-prescription-btn:hover svg {
    transform: rotate(90deg);
}
.nav-tab {
    flex: 1;
    padding: 18px 10px;
    text-align: center;
    cursor: pointer;
    border: none;
    background: white;
    color: #95A5A6;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-bottom: 3px solid transparent;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.nav-tab svg {
    transition: all 0.3s ease;
}

.nav-tab:hover svg {
    transform: scale(1.1);
}

.nav-tab.active svg {
    stroke: var(--primary);
}
.export-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.btn-export {
    padding: 18px 20px;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: white;
}

.btn-export svg {
    transition: transform 0.3s ease;
}

.btn-export:hover svg {
    transform: translateY(3px);
}

.btn-export:active {
    transform: translateY(-1px) scale(0.98);
}

.btn-json {
    background: linear-gradient(135deg, #00B894 0%, #00D2A0 100%);
    box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);
}

.btn-json:hover {
    box-shadow: 0 8px 24px rgba(0, 184, 148, 0.4);
    transform: translateY(-3px);
}

.btn-excel {
    background: linear-gradient(135deg, #54A0FF 0%, #3498DB 100%);
    box-shadow: 0 4px 12px rgba(84, 160, 255, 0.3);
}

.btn-excel:hover {
    box-shadow: 0 8px 24px rgba(84, 160, 255, 0.4);
    transform: translateY(-3px);
}

.btn-text {
    background: linear-gradient(135deg, #FFA502 0%, #FF8C00 100%);
    box-shadow: 0 4px 12px rgba(255, 165, 2, 0.3);
}

.btn-text:hover {
    box-shadow: 0 8px 24px rgba(255, 165, 2, 0.4);
    transform: translateY(-3px);
}

.import-zone {
    background: linear-gradient(135deg, #FFF9E6 0%, #FFECB3 100%);
    border: 3px dashed var(--warning);
    border-radius: 16px;
    padding: 50px 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 30px;
}

.import-zone:hover {
    background: linear-gradient(135deg, #FFECB3 0%, #FFE082 100%);
    border-style: solid;
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(255, 165, 2, 0.2);
}

.import-zone svg {
    transition: transform 0.3s ease;
}

.import-zone:hover svg {
    transform: translateY(-5px);
}

.import-text {
    font-size: 16px;
    font-weight: 700;
    color: var(--warning);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 8px;
}

.import-subtext {
    font-size: 13px;
    color: #95A5A6;
    font-weight: 600;
}
.export-buttons {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.btn-export {
    position: relative;
    padding: 25px 20px;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    border: 3px solid transparent;
}

.btn-export svg {
    transition: all 0.3s ease;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
}

.btn-export:hover svg {
    transform: translateY(-6px) scale(1.1);
    filter: drop-shadow(0 8px 16px rgba(0,0,0,0.25));
}

.btn-export:active {
    transform: scale(0.95);
}

/* JSON Button */
.btn-json {
    background: linear-gradient(135deg, #00B894 0%, #00D2A0 100%);
    box-shadow: 0 6px 20px rgba(0, 184, 148, 0.3);
}

.btn-json:hover {
    background: linear-gradient(135deg, #00D2A0 0%, #00E5B0 100%);
    box-shadow: 0 10px 30px rgba(0, 184, 148, 0.45);
    transform: translateY(-4px);
    border-color: rgba(255,255,255,0.3);
}

/* Excel Button */
.btn-excel {
    background: linear-gradient(135deg, #217346 0%, #2C9A5F 100%);
    box-shadow: 0 6px 20px rgba(33, 115, 70, 0.3);
}

.btn-excel:hover {
    background: linear-gradient(135deg, #2C9A5F 0%, #33A852 100%);
    box-shadow: 0 10px 30px rgba(33, 115, 70, 0.45);
    transform: translateY(-4px);
    border-color: rgba(255,255,255,0.3);
}

/* Text Button */
.btn-text {
    background: linear-gradient(135deg, #FF9500 0%, #FFB340 100%);
    box-shadow: 0 6px 20px rgba(255, 149, 0, 0.3);
}

.btn-text:hover {
    background: linear-gradient(135deg, #FFB340 0%, #FFC870 100%);
    box-shadow: 0 10px 30px rgba(255, 149, 0, 0.45);
    transform: translateY(-4px);
    border-color: rgba(255,255,255,0.3);
}

/* Tooltip */
.btn-export::before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%) scale(0.8);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 700;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    letter-spacing: 0.5px;
}

.btn-export::after {
    content: '';
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.9);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
}

.btn-export:hover::before {
    opacity: 1;
    transform: translateX(-50%) scale(1) translateY(-4px);
}

.btn-export:hover::after {
    opacity: 1;
}
.btn-json {
    background: linear-gradient(135deg, #00B894 0%, #00D2A0 100%);
}

.btn-excel {
    background: linear-gradient(135deg, #217346 0%, #33A852 100%);
}

.btn-text {
    background: linear-gradient(135deg, #FFA502 0%, #FF8C00 100%);
}
.btn-check-wasfaty {
    background: linear-gradient(135deg, #00B894, #00D2A0);
    border: none;
    border-radius: 6px;
    width: 24px;
    height: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 184, 148, 0.3);
    padding: 0;
    flex-shrink: 0;
}

.btn-check-wasfaty svg {
    color: white;
    transition: transform 0.3s ease;
}

.btn-check-wasfaty:hover {
    transform: translateY(-2px) scale(1.08);
    box-shadow: 0 4px 12px rgba(0, 184, 148, 0.5);
    background: linear-gradient(135deg, #00D2A0, #00E5B0);
}

.btn-check-wasfaty:hover svg {
    transform: scale(1.15);
}

.btn-check-wasfaty:active {
    transform: translateY(0) scale(0.95);
}
@keyframes scaleIn {
    from {
        transform: scale(0);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}
/* ============================================ */
/* ستايل خاص للكروت المستوردة (Imported) - تعديل اللون والمكان */
/* ============================================ */
.patient-card.imported {
    /* خلفية برتقالي أغمق وأوضح */
    background: linear-gradient(135deg, #FFF3E0 0%, #FFCC80 100%) !important;
    /* حدود برتقالي محروق */
    border: 2px solid #EF6C00 !important;
}

/* الشريط الجانبي بلون برتقالي قوي */
.patient-card.imported::before {
    background: linear-gradient(180deg, #EF6C00, #E65100) !important;
    width: 8px !important;
}

/* كلمة IMPORTED تحت الاستاتس (أعلى اليمين) */
.patient-card.imported::after {
    content: 'NOT CHECKED';
    position: absolute;
    /* المكان الجديد: تحت الـ Badge مباشرة */
    top: 45px; 
    right: 15px;
    font-size: 24px;
    font-weight: 900;
    /* لون برتقالي بني شفاف */
    color: rgba(230, 81, 0, 0.2); 
    pointer-events: none;
    font-family: 'Arial Black', sans-serif;
    letter-spacing: 1px;
    z-index: 0;
    transform: rotate(-5deg); /* ميلة بسيطة لشكل جمالي */
}
/* ============================================ */
/* QUICK NOTES STYLES */
/* ============================================ */
.quick-notes-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
}

.quick-note-btn {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 20px;
    background: white;
    font-size: 10px;
    font-weight: 700;
    color: #636E72;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
}

.quick-note-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* ألوان الأزرار عند الضغط أو العرض */
.note-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 800;
    color: white;
    margin-right: 5px;
    margin-bottom: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* تخصيص الألوان لكل نوع */
.badge-need-rx { background: linear-gradient(135deg, #ff9f43, #e67e22); }
.badge-sensor { background: linear-gradient(135deg, #54a0ff, #2e86de); }
.badge-insulin { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
.badge-no-answer { background: linear-gradient(135deg, #636e72, #2d3436); }
.badge-rejected { background: linear-gradient(135deg, #ff6b6b, #ee5253); }
.badge-dispensed { background: linear-gradient(135deg, #1dd1a1, #10ac84); }
/* أضف هذا السطر لزر VIP الجديد */
.badge-vip { background: linear-gradient(135deg, #f1c40f, #f39c12); color: black !important; border: 1px solid #e67e22; }

/* هذا الستايل الجديد لأي ملاحظة عادية مكتوبة يدوياً (أزرق افتراضي) */
.badge-default { background: linear-gradient(135deg, #3498db, #2980b9); }
/* زر النسخ فقط */
.btn-copy-only {
    background: #e2e8f0; /* لون رصاصي فاتح */
    border: none;
    border-radius: 6px;
    width: 24px;
    height: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-left: 5px; /* مسافة صغيرة بينه وبين زر وصفتي */
    color: #475569;
}

.btn-copy-only:hover {
    background: #cbd5e1;
    color: #1e293b;
    transform: translateY(-2px);
}

.btn-copy-only:active {
    transform: scale(0.95);
}
/* ============================================ */
/* DISPENSED TAB STYLES */
/* ============================================ */
.dispense-search-container {
    position: relative;
    margin-bottom: 20px;
}

.dispense-results-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--border);
    border-top: none;
    border-radius: 0 0 12px 12px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    display: none;
}

.dispense-result-item {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dispense-result-item:hover {
    background: #F8F9FE;
}

.dispensing-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.dispensing-table th {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 15px;
    text-align: left;
    font-size: 12px;
    text-transform: uppercase;
}

.dispensing-table td {
    padding: 15px;
    border-bottom: 1px solid #eee;
    color: var(--dark);
    font-weight: 600;
    vertical-align: middle;
}

.dispensing-table tr.completed {
    background-color: #e8f5e9;
    text-decoration: line-through;
    color: #aaa;
    opacity: 0.6;
    transition: all 0.3s ease;
}

.dispense-checkbox {
    width: 24px;
    height: 24px;
    cursor: pointer;
    accent-color: var(--secondary);
}

.rx-chips-mini {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.rx-chip-mini {
    background: #E3F2FD;
    color: var(--primary);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-family: monospace;
}
/* ============================================ */
/* MOBILE RESPONSIVENESS FIXES */
/* ============================================ */

/* 1. ضبط الحاوية الرئيسية لتتناسب مع عرض الشاشة */
@media (max-width: 768px) {
    .container {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 10px !important;
        overflow-x: hidden; /* منع الصفحة كاملة من الانزلاق يميناً ويساراً */
    }

    /* 2. تحسين عرض التابات */
    .nav-tabs {
        flex-wrap: nowrap;
        overflow-x: auto; /* السماح بالتمرير إذا كثرت التابات */
        padding-bottom: 5px;
    }
    
    .nav-tab {
        padding: 12px 5px;
        font-size: 11px;
        min-width: 70px;
    }

    /* 3. إصلاح جدول الـ Dispensed على الموبايل */
    .dispensing-table-container {
        border-radius: 12px;
        border: 1px solid #eee;
        overflow-x: auto; /* يجعل الجدول هو فقط من يتحرك يميناً ويساراً */
        -webkit-overflow-scrolling: touch; /* حركة ناعمة على الآيفون */
        margin-top: 15px;
        width: 100%;
        display: block;
    }

    .dispensing-table {
        width: 100%;
        min-width: 600px; /* تحديد حد أدنى للعرض لضمان عدم تداخل النصوص */
    }

    /* تحسين المسافات داخل الجدول للموبايل */
    .dispensing-table th, 
    .dispensing-table td {
        padding: 10px 8px; /* تقليل الحواف */
        font-size: 12px;
    }

    /* 4. ضبط شريط البحث والفلتر في صفحة Dispensed */
    .dispense-search-container {
        width: 100%;
        padding: 0;
    }

    /* جعل شريط الفلتر والعداد يظهرون بشكل مرتب عمودياً */
    .dispensing-table-container > div:first-child {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .dispensing-table-container > div:first-child > div:last-child {
        width: 100% !important; /* شريط البحث الداخلي يأخذ العرض كامل */
    }

    /* 5. تصغير الأزرار والأيقونات قليلاً */
    .btn-remove-queue {
        width: 24px;
        height: 24px;
    }
    
    .dispense-checkbox {
        width: 20px;
        height: 20px;
    }

    .rx-chip-mini {
        padding: 2px 5px;
        font-size: 10px;
    }
}
/* ============================================ */
/* FLOATING DOCS BOX STYLES */
/* ============================================ */
.floating-docs-btn {
    position: fixed;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(180deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 20px 8px;
    border-radius: 12px 0 0 12px;
    cursor: pointer;
    z-index: 9999;
    box-shadow: -4px 4px 15px rgba(0,0,0,0.2);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    border-right: none;
}

.floating-docs-btn:hover {
    padding-right: 15px;
    background: linear-gradient(180deg, var(--secondary), #00D2A0);
    transform: translateY(-50%) translateX(-5px);
}

.floating-docs-btn .icon-doc {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
}

/* File List Styles inside Modal */
.file-upload-area {
    border: 2px dashed #B2BEC3;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    background: #F8F9FE;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.file-upload-area:hover {
    border-color: var(--primary);
    background: #E3F2FD;
}

.files-list-container {
    max-height: 300px;
    overflow-y: auto;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: white;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #eee;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}

.file-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border-color: var(--primary);
}

.file-info {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
    overflow: hidden;
}

.file-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: white;
    flex-shrink: 0;
}

.type-pdf { background: #FF6B6B; }
.type-excel { background: #21A366; }
.type-img { background: #54A0FF; }
.type-txt { background: #FFA502; }
.type-other { background: #636E72; }

.file-details {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.file-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-size {
    font-size: 10px;
    color: #999;
}

.file-actions {
    display: flex;
    gap: 5px;
}

.btn-icon-small {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-view { background: #E3F2FD; color: var(--primary); }
.btn-share { background: #E0F2F1; color: #00B894; }
.btn-del { background: #FFEBEE; color: #FF6B6B; }

.btn-icon-small:hover { transform: scale(1.1); }
/* زرار Reset الفلاتر */
.btn-reset-filter {
    background: linear-gradient(135deg, #636E72, #2D3436);
    color: white;
    border: none;
    border-radius: 10px;
    width: 50px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(99, 110, 114, 0.3);
}

.btn-reset-filter:hover {
    background: linear-gradient(135deg, #2D3436, #000);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 110, 114, 0.5);
}

.btn-reset-filter:active {
    transform: scale(0.95);
}

.btn-reset-filter svg {
    transition: transform 0.3s ease;
}

.btn-reset-filter:hover svg {
    transform: rotate(-180deg);
}
/* ألوان للكاردات في Dispensing Queue */
.dispensing-table tbody tr {
    cursor: pointer;
    transition: all 0.3s ease;
}

.dispensing-table tbody tr:hover {
    background-color: #f5f5f5 !important;
}

/* ألوان مختلفة للكاردات */
.dispensing-table tbody tr.color-none {
    background-color: white;
}

.dispensing-table tbody tr.color-green {
    background-color: #E8F5E9 !important;
}

.dispensing-table tbody tr.color-yellow {
    background-color: #FFF9C4 !important;
}

.dispensing-table tbody tr.color-blue {
    background-color: #E3F2FD !important;
}

.dispensing-table tbody tr.color-red {
    background-color: #FFEBEE !important;
}

.dispensing-table tbody tr.color-purple {
    background-color: #F3E5F5 !important;
}
/* دائرة اللون البسيطة - Toggle فقط */
.color-indicator {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: inline-block;
    border: 3px solid #ddd;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.color-indicator:hover {
    transform: scale(1.15);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* اللون الأزرق عند التفعيل */
.color-indicator.active {
    background: #0d47a1 !important;
    border-color: #0d47a1 !important;
}

/* إخفاء Color Picker Dropdown تماماً */
.color-picker-dropdown {
    display: none !important;
}

/* تلوين الصف بأزرق فاتح */
.dispensing-table tbody tr.color-blue {
    background-color: #E3F2FD !important;
}

/* تنسيق بوكس تجميع الواردات */
.import-batch-container {
    background: white;
    border: 2px solid #E0E0E0;
    border-radius: 16px;
    margin-bottom: 25px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.import-batch-header {
    background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
    color: white;
    padding: 12px 20px;
    font-size: 13px;
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
    letter-spacing: 0.5px;
}

.import-batch-header .batch-time {
    background: rgba(255,255,255,0.2);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-family: monospace;
}

.import-batch-grid {
    padding: 15px;
    display: grid;
    /* نفس تصميم الكروت العادية */
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
    gap: 15px;
    background: #FAFAFA;
}
/* تنسيق بوكس تجميع الواردات */
.import-batch-container {
    background: #f8f9fa;
    border: 1px solid #dcdcdc;
    border-radius: 12px;
    margin-bottom: 30px;
    overflow: hidden; /* عشان الهيدر يبقى جوه الحدود */
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    animation: slideUp 0.3s ease;
}

/* الهيدر الأسود */
.import-batch-header {
    background: #2D3436; /* لون أسود فحمي */
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 4px solid #00B894; /* خط أخضر جمالي تحت الهيدر */
}

/* شبكة الكروت داخل البوكس */
.import-batch-grid {
    padding: 20px;
    display: grid;
    /* هذا السطر يجعل الكروت تتجاوب مع الشاشة: كارتين أو ثلاثة بجانب بعض */
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
    gap: 15px;
}
/* رسالة تنبيه سريعة (Toast) بدلاً من المودال التقيل */
.toast-notification {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px); /* مخفية تحت */
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 12px 24px;
    border-radius: 50px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 10000;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.toast-notification.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}
    </style>
</head>
<body>
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-box" id="modalContent">
            </div>
    </div>
    
    <div id="authPage" class="auth-container">
        <div class="auth-box">
            <div class="auth-logo">
                <img src="https://raw.githubusercontent.com/meralmohamed121022-cyber/Drug-Monograph/refs/heads/main/M%20(512%20x%20512%20px)_20251114_182650_0000.gif" 
                     alt="MONO Logo" 
                     style="width: 150px; height: auto; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px;">
                <p>Mono Wasfaty</p>
            </div>
            
            <div class="auth-toggle">
                <button id="loginToggle" class="active" onclick="showLogin()">Login</button>
                <button id="signupToggle" onclick="showSignup()">Sign Up</button>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Pharmacy NO
                    </label>
                    <input type="text" class="form-input" id="loginPharmacyCode" placeholder="PH1" required pattern="PH[0-9]{1,4}" maxlength="6">
                    <small style="color: #636E72; font-size: 11px; margin-top: 5px; display: block;">Format: PH1 to PH1000</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span style="font-size: 18px; margin-right: 8px;">🔐</span>
                        Password
                    </label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter password" required>
                </div>
                
                <button type="submit" class="btn-primary" id="loginBtn">
                    <span id="loginBtnText">LOGIN</span>
                    <span id="loginBtnLoading" style="display:none;" class="loading"></span>
                </button>
            </form>
            
            <form id="signupForm" onsubmit="handleSignup(event)" style="display:none;">
                <div class="form-group">
                    <label class="form-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Pharmacy NO
                    </label>
                    <input type="text" class="form-input" id="signupPharmacyCode" placeholder="PH1" required pattern="PH[0-9]{1,4}" maxlength="6">
                    <small style="color: #636E72; font-size: 11px; margin-top: 5px; display: block;">Choose PH1 to PH1000</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span style="font-size: 18px; margin-right: 8px;">🏪</span>
                        Pharmacist Name (Optional)
                    </label>
                    <input type="text" class="form-input" id="signupPharmacyName" placeholder="Main Pharmacy">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span style="font-size: 18px; margin-right: 8px;">🔐</span>
                        Password
                    </label>
                    <input type="password" class="form-input" id="signupPassword" placeholder="Enter password" required minlength="6">
                    <small style="color: #636E72; font-size: 11px; margin-top: 5px; display: block;">Minimum 6 characters</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span style="font-size: 18px; margin-right: 8px;">🔐</span>
                        Confirm Password
                    </label>
                    <input type="password" class="form-input" id="signupPasswordConfirm" placeholder="Re-enter password" required>
                </div>
                
                <div class="info-box">
                    <strong>Important:</strong>
                    Remember your pharmacy NO and password - you'll need them to login!
                </div>
                
                <button type="submit" class="btn-primary" id="signupBtn">
                    <span id="signupBtnText">CREATE ACCOUNT</span>
                    <span id="signupBtnLoading" style="display:none;" class="loading"></span>
                </button>
            </form>
        </div>
    </div>
    <div id="mainApp" style="display:none;">
        <div class="header">
            <img src="https://raw.githubusercontent.com/meralmohamed121022-cyber/Drug-Monograph/refs/heads/main/M%20(512%20x%20512%20px)_20251114_182650_0000.gif" 
                 alt="MONO Logo" 
                 style="width: 80px; height: auto; border-radius: 50%; margin-bottom: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            
            <p id="pharmacyInfo">Mono Wasfaty SYSTEM</p>
            
            <button class="logout-btn" onclick="handleLogout()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </button>
        </div>
      <div class="container">
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('add')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add
        </button>
        <button class="nav-tab" onclick="switchTab('patients')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Patients
        </button>
        <button class="nav-tab" onclick="switchTab('data')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
            </svg>
            Data Hub
        </button>
        <button class="nav-tab" onclick="switchTab('dispensed')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            Dispensed
        </button>
    </div>

    <div id="add-tab" class="tab-content active">
        <div class="form-group">
            <label class="form-label">
                <span style="font-size: 18px; margin-right: 8px;">🆔</span>
                ID Number (10 digits)
            </label>
            <input type="text" class="form-input" id="nationalId" placeholder="1234567890" maxlength="10" pattern="[1-4][0-9]{9}">
        </div>

        <div class="form-group">
            <label class="form-label">
                <span style="font-size: 18px; margin-right: 8px;">📱</span>
                Phone Number (Optional)
            </label>
            <input type="text" class="form-input" id="phoneNumber" placeholder="05xxxxxxxx" maxlength="10">
        </div>

        <div class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Prescriptions
        </div>

        <div id="prescriptionsContainer"></div>

        <button class="add-prescription-btn" onclick="addPrescription()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Another Prescription
        </button>

        <div class="form-group" style="margin-top: 25px;">
            <label class="form-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                SELECT REFILL DURATION
            </label>
            <p style="font-size: 12px; color: #636E72; margin-bottom: 10px;">Next refill date will auto-calculate</p>
            <div class="refill-selector">
                <div class="refill-box active" data-days="24" onclick="selectRefill(24)">
                    <div class="duration">1</div>
                    <div class="label">Month</div>
                </div>
                <div class="refill-box" data-days="48" onclick="selectRefill(48)">
                    <div class="duration">2</div>
                    <div class="label">Months</div>
                </div>
                <div class="refill-box" data-days="72" onclick="selectRefill(72)">
                    <div class="duration">3</div>
                    <div class="label">Months</div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Dispensing Date
            </label>
            <input type="date" class="form-input" id="dispensingDate">
        </div>

        <div class="form-group">
            <label class="form-label">
                <span style="font-size: 18px; margin-right: 8px;">🔄</span>
                Next Refill Date
            </label>
            <input type="date" class="form-input" id="nextRefillDate" onclick="this.showPicker()">
        </div>

        <div class="section-title">
            <span style="font-size: 18px;">📝</span>
            Additional Notes
        </div>

        <div class="quick-notes-grid">
            <button class="quick-note-btn" onclick="addQuickNote('⭐ VIP')">⭐ VIP</button>
            <button class="quick-note-btn" onclick="addQuickNote('NEED NEW RX NO')">⚠️ NEED NEW RX NO</button>
            <button class="quick-note-btn" onclick="addQuickNote('SENSOR')">📡 SENSOR</button>
            <button class="quick-note-btn" onclick="addQuickNote('INSULIN')">💉 INSULIN</button>
            <button class="quick-note-btn" onclick="addQuickNote('NO ANSWER')">📞 NO ANSWER</button>
            <button class="quick-note-btn" onclick="addQuickNote('REJECTED')">❌ REJECTED</button>
            <button class="quick-note-btn" onclick="addQuickNote('DISPENSED')">✅ DISPENSED</button>
        </div>
        <div class="form-group">
            <textarea class="form-input" id="generalNote" rows="4" placeholder="Add general notes here..." style="resize: vertical;"></textarea>
        </div>

        <button class="btn-primary" onclick="savePatient()" id="saveBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            <span id="saveButtonText">ADD PATIENT</span>
        </button>

        <button class="btn-import" onclick="document.getElementById('importFile').click()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            IMPORT DATA
        </button>
        <input type="file" id="importFile" accept=".json,.xlsx,.xls,.txt" style="display:none;">
    </div>

    <div id="patients-tab" class="tab-content">
        <div class="stats-grid" id="statsGrid"></div>

        <div class="search-box">
            <div class="search-icon-wrapper">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#B2BEC3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </div>
            <input type="text" class="search-input" id="searchInput" placeholder="Search by ID, prescription..." oninput="searchPatients()">
        </div>
       <div class="date-filter" style="grid-template-columns: 1fr 1fr auto; gap: 10px;">
    <input type="date" 
           id="filterDateFrom" 
           lang="en-GB"
           onchange="applyDateFilter()">
    
    <input type="date" 
           id="filterDateTo" 
           lang="en-GB"
           onchange="applyDateFilter()">
    
    <button class="btn-reset-filter" onclick="resetFilters()" title="Reset Filters">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
            <path d="M21 3v5h-5"></path>
            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
            <path d="M3 21v-5h5"></path>
        </svg>
    </button>
</div>

<div class="filter-chips" style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px;">
    <div class="chip active" onclick="filterPatients('all')">All</div>
    <div class="chip" onclick="filterPatients('today')">Due Today</div>
    <div class="chip" onclick="filterPatients('upcoming')">Upcoming Week</div>
    <div class="chip" onclick="filterPatients('overdue')">Overdue</div>
    <div class="chip" onclick="filterPatients('imported')">Imported</div>

    <div class="chip" 
         onclick="checkExactDuplicatesReport()" 
         style="background: linear-gradient(135deg, #ff9f43, #ee5253); color: white; border: none; display: flex; align-items: center; gap: 5px; padding-left: 10px; padding-right: 10px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        Clean Duplicates
    </div>
</div>
        <div id="patientsContainer"></div>
    </div>

    <div id="data-tab" class="tab-content">
        <div class="export-section">
            <div class="export-title">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--dark)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                EXPORT DATA
            </div>
            <p style="font-size: 12px; color: #636E72; margin-bottom: 15px;">Export database in different formats</p>
            <div class="export-buttons">
                <button class="btn-export btn-json" onclick="exportData('json')" data-tooltip="Export JSON">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none">
                        <rect x="3" y="3" width="18" height="18" rx="3" fill="white" opacity="0.15"/>
                        <rect x="5" y="5" width="14" height="14" rx="2" stroke="white" stroke-width="1.6"/>
                        <path d="M10 8.5c-.8 0-1.2.4-1.2 1.2v1.1c0 .6-.3.9-.9.9h-.4M7.9 12.7h.4c.6 0 .9.3.9.9v1.1c0 .8.4 1.2 1.2 1.2" stroke="white" stroke-width="1.4" stroke-linecap="round"/>
                        <path d="M14 8.5c.8 0 1.2.4 1.2 1.2v1.1c0 .6.3.9.9.9h.4M16.1 12.7h-.4c-.6 0-.9.3-.9.9v1.1c0 .8-.4 1.2-1.2 1.2" stroke="white" stroke-width="1.4" stroke-linecap="round"/>
                    </svg>
                </button>

                <button class="btn-export btn-excel" onclick="exportData('excel')" data-tooltip="Export Excel">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none">
                        <path d="M7 3h7l4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" fill="#185C37"/>
                        <path d="M14 3v4h4" fill="#21A366"/>
                        <rect x="4" y="7" width="9.5" height="10" fill="white" opacity="0.95"/>
                        <path d="M6.2 9l2.1 3.1L6.1 15h1.4l1.1-1.8L9.7 15h1.4l-2.1-2.9L11 9H9.6L8.5 10.7 7.4 9H6.2z" fill="#185C37"/>
                    </svg>
                </button>

                <button class="btn-export btn-text" onclick="exportData('text')" data-tooltip="Export Text">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none">
                        <path d="M7 3h7l4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" fill="#FF9500"/>
                        <path d="M14 3v4h4" fill="#FFC766"/>
                        <line x1="8" y1="11" x2="16" y2="11" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
                        <line x1="8" y1="14" x2="16" y2="14" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
                        <line x1="8" y1="17" x2="13" y2="17" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="export-section">
            <div class="export-title">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--dark)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                IMPORT DATA
            </div>
            <div class="import-area" onclick="document.getElementById('importFileData').click()">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 15px; display: block;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div class="import-text">CLICK TO IMPORT</div>
                <p style="font-size: 11px; color: #999; margin-top: 10px;">Supports JSON, Excel, Text</p>
            </div>
            <input type="file" id="importFileData" accept=".json,.xlsx,.xls,.txt" style="display:none;">
        </div>

        <div id="importPreview"></div>

        <div class="export-section">
            <div class="export-title">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--dark)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                </svg>
                BACKUP SYSTEM
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-export btn-json" onclick="createBackup()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Backup
                </button>
                <button class="btn-export btn-excel" onclick="restoreBackup()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Restore
                </button>
            </div>
            <button class="btn-export" style="background: linear-gradient(135deg, #FF6B6B, #EE5A6F); color: white; width: 100%; margin-top: 10px;" onclick="deleteAll()">
                <svg width="16" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                Delete All
            </button>
        </div>
    </div>
    <div id="dispensed-tab" class="tab-content">
    <div class="section-title">
        <span style="font-size: 20px;">💊</span>
        Daily Dispensing Queue
    </div>

    <div class="dispense-search-container">
        <div class="search-box" style="margin-bottom: 0;">
            <div class="search-icon-wrapper">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#B2BEC3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </div>
            <input type="text" class="search-input" id="dispenseSearchInput" 
                   placeholder="Search database to ADD to queue..." 
                   oninput="searchForDispensing()" autocomplete="off">
        </div>
        <div id="dispenseSearchResults" class="dispense-results-dropdown"></div>
    </div>

    <div class="dispensing-table-container" style="margin-top: 20px;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee; background: #fcfcfc;">
            <div style="font-size: 14px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                📋 Queue List 
                <span id="queueCount" style="background: var(--secondary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">0</span>
            </div>
            
            <div style="position: relative; width: 250px;">
                <input type="text" id="queueFilterInput" 
                       placeholder="Filter within list..." 
                       onkeyup="filterQueue()"
                       style="width: 100%; padding: 8px 30px 8px 10px; border: 1px solid #ddd; border-radius: 20px; font-size: 12px; outline: none; transition: border 0.3s;">
                <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; opacity: 0.5;">🔍</div>
            </div>
        </div>

        <table class="dispensing-table">
            <thead>
                <tr>
                    <th width="40" style="text-align: center; color: #D32F2F;">✖</th>
                    
                    <th width="40">#</th>
                    
                    <th>Patient Details</th>
                    <th>Prescriptions</th>
                    <th>Mobile</th>
                    
                    <th width="80" style="text-align: center;">Done</th>
                </tr>
            </thead>
            <tbody id="dispensingQueueBody">
                </tbody>
        </table>
        
        <div id="emptyDispenseMsg" class="no-data" style="padding: 50px 20px;">
            <div class="icon icon-pill" style="width: 40px; height: 16px; background: #E0E0E0; margin: 0 auto 15px;"></div>
            <p style="font-size: 14px; color: #B2BEC3;">Queue is empty. Search above to add patients.</p>
        </div>
    </div>
</div>
            
            <!-- Add Patient Tab -->
            <div id="add-tab" class="tab-content active">
                <div class="form-group">
                    <label class="form-label">
                        <span style="font-size: 18px; margin-right: 8px;">🆔</span>
                        ID Number (10 digits)
                    </label>
                    <input type="text" class="form-input" id="nationalId" placeholder="1234567890" maxlength="10" pattern="[1-4][0-9]{9}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span style="font-size: 18px; margin-right: 8px;">📱</span>
                        Phone Number (Optional)
                    </label>
                    <input type="text" class="form-input" id="phoneNumber" placeholder="05xxxxxxxx" maxlength="10">
                </div>
                
                <div class="section-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    Prescriptions
                </div>
                
                <div id="prescriptionsContainer"></div>
                
                <button class="add-prescription-btn" onclick="addPrescription()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Another Prescription
                </button>
                
                <div class="form-group" style="margin-top: 25px;">
                    <label class="form-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        SELECT REFILL DURATION
                    </label>
                    <p style="font-size: 12px; color: #636E72; margin-bottom: 10px;">Next refill date will auto-calculate</p>
                    <div class="refill-selector">
                        <div class="refill-box active" data-days="24" onclick="selectRefill(24)">
                            <div class="duration">1</div>
                            <div class="label">Month</div>
                        </div>
                        <div class="refill-box" data-days="48" onclick="selectRefill(48)">
                            <div class="duration">2</div>
                            <div class="label">Months</div>
                        </div>
                        <div class="refill-box" data-days="72" onclick="selectRefill(72)">
                            <div class="duration">3</div>
                            <div class="label">Months</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Dispensing Date
                    </label>
                    <input type="date" class="form-input" id="dispensingDate">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span style="font-size: 18px; margin-right: 8px;">🔄</span>
                        Next Refill Date
                    </label>
                 <input type="date" class="form-input" id="nextRefillDate" onclick="this.showPicker()">
                </div>
             <div class="section-title">
    <span style="font-size: 18px;">📝</span>
    Additional Notes
</div>

<div class="quick-notes-grid">
    <button class="quick-note-btn" onclick="addQuickNote('⭐ VIP')">⭐ VIP</button>
    <button class="quick-note-btn" onclick="addQuickNote('NEED NEW RX NO')">⚠️ NEED NEW RX NO</button>
    <button class="quick-note-btn" onclick="addQuickNote('SENSOR')">📡 SENSOR</button>
    <button class="quick-note-btn" onclick="addQuickNote('INSULIN')">💉 INSULIN</button>
    <button class="quick-note-btn" onclick="addQuickNote('NO ANSWER')">📞 NO ANSWER</button>
    <button class="quick-note-btn" onclick="addQuickNote('REJECTED')">❌ REJECTED</button>
    <button class="quick-note-btn" onclick="addQuickNote('DISPENSED')">✅ DISPENSED</button>
</div>
<div class="form-group">
    <textarea class="form-input" id="generalNote" rows="4" placeholder="Add general notes here..." style="resize: vertical;"></textarea>
</div>
                <button class="btn-primary" onclick="savePatient()" id="saveBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    <span id="saveButtonText">ADD PATIENT</span>
                </button>
                
                <button class="btn-import" onclick="document.getElementById('importFile').click()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    IMPORT DATA
                </button>
                <input type="file" id="importFile" accept=".json,.xlsx,.xls,.txt" style="display:none;">
            </div>
            
            <!-- Patients List Tab -->
            <div id="patients-tab" class="tab-content">
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="search-box">
                    <div class="search-icon-wrapper">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#B2BEC3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </div>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search by ID, prescription..." oninput="searchPatients()">
                </div>
                
                <div class="date-filter">
                    <input type="date" id="filterDateFrom" placeholder="From Date" onchange="applyDateFilter()">
                    <input type="date" id="filterDateTo" placeholder="To Date" onchange="applyDateFilter()">
                </div>
                
                <div class="filter-chips">
                    <div class="chip active" onclick="filterPatients('all')">All</div>
                    <div class="chip" onclick="filterPatients('today')">Due Today</div>
                    <div class="chip" onclick="filterPatients('upcoming')">Upcoming Week</div>
                    <div class="chip" onclick="filterPatients('overdue')">Overdue</div>
                    <div class="chip" onclick="filterPatients('imported')">Imported</div>
                </div>
                
                <div id="patientsContainer"></div>
            </div>
            
            <!-- Data Management Tab -->
            <div id="data-tab" class="tab-content">
                <div class="export-section">
                    <div class="export-title">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--dark)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        EXPORT DATA
                    </div>
                    <p style="font-size: 12px; color: #636E72; margin-bottom: 15px;">Export database in different formats</p>
             <div class="export-buttons">
    <!-- JSON -->
    <button class="btn-export btn-json" onclick="exportData('json')" data-tooltip="Export JSON">
        <svg width="50" height="50" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="18" rx="3" fill="white" opacity="0.15"/>
            <rect x="5" y="5" width="14" height="14" rx="2" stroke="white" stroke-width="1.6"/>
            <!-- { -->
            <path d="M10 8.5c-.8 0-1.2.4-1.2 1.2v1.1c0 .6-.3.9-.9.9h-.4
                     M7.9 12.7h.4c.6 0 .9.3.9.9v1.1c0 .8.4 1.2 1.2 1.2"
                  stroke="white" stroke-width="1.4" stroke-linecap="round"/>
            <!-- } -->
            <path d="M14 8.5c.8 0 1.2.4 1.2 1.2v1.1c0 .6.3.9.9.9h.4
                     M16.1 12.7h-.4c-.6 0-.9.3-.9.9v1.1c0 .8-.4 1.2-1.2 1.2"
                  stroke="white" stroke-width="1.4" stroke-linecap="round"/>
        </svg>
    </button>

    <!-- Excel -->
    <button class="btn-export btn-excel" onclick="exportData('excel')" data-tooltip="Export Excel">
        <svg width="50" height="50" viewBox="0 0 24 24" fill="none">
            <!-- ملف أخضر زي شعار Excel -->
            <path d="M7 3h7l4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"
                  fill="#185C37"/>
            <path d="M14 3v4h4" fill="#21A366"/>
            <!-- مربع أبيض جوه -->
            <rect x="4" y="7" width="9.5" height="10" fill="white" opacity="0.95"/>
            <!-- حرف X -->
            <path d="M6.2 9l2.1 3.1L6.1 15h1.4l1.1-1.8L9.7 15h1.4l-2.1-2.9L11 9H9.6L8.5 10.7 7.4 9H6.2z"
                  fill="#185C37"/>
        </svg>
    </button>

    <!-- TEXT -->
    <button class="btn-export btn-text" onclick="exportData('text')" data-tooltip="Export Text">
        <svg width="50" height="50" viewBox="0 0 24 24" fill="none">
            <!-- ملف برتقالي -->
            <path d="M7 3h7l4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"
                  fill="#FF9500"/>
            <path d="M14 3v4h4" fill="#FFC766"/>
            <!-- خطوط النص -->
            <line x1="8" y1="11" x2="16" y2="11" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
            <line x1="8" y1="14" x2="16" y2="14" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
            <line x1="8" y1="17" x2="13" y2="17" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
    </button>
</div>


</div>
                
                <div class="export-section">
                    <div class="export-title">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--dark)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        IMPORT DATA
                    </div>
                    <div class="import-area" onclick="document.getElementById('importFileData').click()">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 15px; display: block;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <div class="import-text">CLICK TO IMPORT</div>
                        <p style="font-size: 11px; color: #999; margin-top: 10px;">Supports JSON, Excel, Text</p>
                    </div>
                    <input type="file" id="importFileData" accept=".json,.xlsx,.xls,.txt" style="display:none;">
                </div>
                
                <div id="importPreview"></div>
                
                <div class="export-section">
                    <div class="export-title">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--dark)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                        </svg>
                        BACKUP SYSTEM
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn-export btn-json" onclick="createBackup()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Backup
                        </button>
                        <button class="btn-export btn-excel" onclick="restoreBackup()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Restore
                        </button>
                    </div>
                    <button class="btn-export" style="background: linear-gradient(135deg, #FF6B6B, #EE5A6F); color: white; width: 100%; margin-top: 10px;" onclick="deleteAll()">
                        <svg width="16" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                        Delete All
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="floating-docs-btn" onclick="openDocsManager()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="12" y1="18" x2="12" y2="12"></line>
        <line x1="9" y1="15" x2="15" y2="15"></line>
    </svg>
    <span class="icon-doc">DOCS</span>
</div>

<input type="file" id="docsUploader" multiple accept=".txt,.xlsx,.xls,.pdf,.jpg,.jpeg,.png" style="display: none;" onchange="handleDocsUpload(this)">
    <div id="whatsappExportContainer" class="whatsapp-export-container"></div>
<div id="toastNotification" class="toast-notification">
    <span>✅</span> <span id="toastText">Copied to clipboard!</span>
</div>
<img src="https://raw.githubusercontent.com/meralmohamed121022-cyber/Drug-Monograph/refs/heads/main/6_20251129_184528_0005.png" alt="Ph Mohamed Kholeif"
style="position: fixed; bottom: 10px; right: 10px; width: 100px; height: 100px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); background: white; padding: 2px; animation: float 4s ease-in-out infinite; z-index: 1000; cursor: pointer;"
id="profileImage" />

<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html2canvas@latest/dist/html2canvas.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://gmymnsvwavfmhyzjjchv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdteW1uc3Z3YXZmbWh5empqY2h2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5OTQ0MjcsImV4cCI6MjA4NDU3MDQyN30.CrzfV5R9kSSlvZY3XhFVtxbrlr-qupzRtImGLmp7cf4';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let patients = [];
        let editingPatientId = null;
        let selectedRefillDays = 24;
        let currentFilter = 'all';
        let fuse = null;
        let pendingImportData = null;
        
        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function showModal(title, content, actions) {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-title">${title}</div>
                    <button class="modal-close" onclick="closeModal()">×</button>
                </div>
                <div class="modal-content">${content}</div>
                ${actions ? `<div class="modal-actions">${actions}</div>` : ''}
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }
        
    function confirmAction(message, callback) {
    showModal(
        '<span style="color: var(--warning);">⚠️ CONFIRM</span>',
        `<p style="text-align: center; padding: 30px 20px; font-size: 16px; color: var(--dark);">${message}</p>`,
        `
        <button class="btn-secondary" onclick="closeModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Cancel
        </button>
        <button class="btn-primary" onclick="closeModal(); confirmCallback();">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Confirm
        </button>
        `
    );
    
    window.confirmCallback = callback;
}

        // ============================================
        // DUPLICATE DETECTION
        // ============================================
        async function checkDuplicates(nationalId, prescriptionNumbers) {
            const duplicatesByID = patients.filter(p => p.nationalId === nationalId);
            const duplicatesByPrescription = patients.filter(p => 
                p.prescriptions.some(presc => 
                    prescriptionNumbers.includes(presc.number)
                )
            );
            
            if (duplicatesByID.length > 0 || duplicatesByPrescription.length > 0) {
                const allDuplicates = [...new Set([...duplicatesByID, ...duplicatesByPrescription])];
                showDuplicatesModal(allDuplicates, nationalId, prescriptionNumbers);
                return true;
            }
            return false;
        }
        
        function showDuplicatesModal(duplicates, newID, newPrescriptions) {
            const duplicatesHTML = duplicates.map(patient => {
                const matchID = patient.nationalId === newID;
                const matchPrescriptions = patient.prescriptions.some(p => newPrescriptions.includes(p.number));
                
                return `
                    <div class="duplicate-card">
                        <div class="card-id">
                            ${matchID ? '🔴 ' : ''}ID: ${patient.nationalId}
                        </div>
                        <div style="font-size: 12px; color: #636E72; margin-bottom: 10px;">
                            <strong>Dispensing:</strong> ${patient.dispensingDate}<br>
                            <strong>Next Refill:</strong> ${patient.nextRefillDate}
                        </div>
                        <div class="card-prescriptions">
                            <strong style="font-size: 11px; color: var(--primary);">Prescriptions:</strong><br>
                            ${patient.prescriptions.map(p => 
                                `<span class="presc-tag" style="${newPrescriptions.includes(p.number) ? 'background: var(--danger);' : ''}">${p.number}</span>`
                            ).join('')}
                        </div>
                        <div class="qr-mini" id="qr-modal-${patient.id}"></div>
                        <div class="card-actions">
                            <button class="btn-action btn-edit" onclick="closeModal(); editPatient('${patient.id}')">
                                <div class="icon icon-edit" style="color: white; width: 14px; height: 14px;"></div>
                                Edit
                            </button>
                            <button class="btn-action btn-delete" onclick="closeModal(); deletePatient('${patient.id}')">
                                <div class="icon icon-delete" style="color: white; width: 12px; height: 14px;"></div>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            showModal(
                '<span style="color: var(--danger);">⚠️ Duplicate Records Found</span>',
                `
                    <p style="margin-bottom: 20px; color: #636E72;">Found ${duplicates.length} existing record(s) matching this data:</p>
                    <div style="max-height: 400px; overflow-y: auto;">${duplicatesHTML}</div>
                `,
                `
                    <button class="btn-primary" onclick="closeModal(); proceedWithSave()">Continue Anyway</button>
                    <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                `
            );
            
            // Generate QR codes for duplicates
            setTimeout(() => {
                duplicates.forEach(patient => {
                    const container = document.getElementById(`qr-modal-${patient.id}`);
                    if (container) {
                        container.innerHTML = '';
                        const qrID = createMiniQR(patient.nationalId, 'ID');
                        container.appendChild(qrID);
                        patient.prescriptions.forEach((presc, idx) => {
                            const qrPresc = createMiniQR(presc.number, `RX${idx + 1}`);
                            container.appendChild(qrPresc);
                        });
                    }
                });
            }, 100);
        }
        
        function createMiniQR(text, label) {
            const box = document.createElement('div');
            box.className = 'qr-mini-box';
            
            const qrDataUrl = generateQRCode(text);
            if (qrDataUrl) {
                const img = document.createElement('img');
                img.src = qrDataUrl;
                box.appendChild(img);
            }
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'qr-mini-label';
            labelDiv.textContent = label;
            box.appendChild(labelDiv);
            
            return box;
        }
        
        let pendingSaveData = null;
        
        function proceedWithSave() {
            if (pendingSaveData) {
                actualSavePatient(pendingSaveData);
                pendingSaveData = null;
            }
        }
        
        // ============================================
        // AUTH FUNCTIONS
        // ============================================
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginToggle').classList.add('active');
            document.getElementById('signupToggle').classList.remove('active');
        }
        
        function showSignup() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('loginToggle').classList.remove('active');
            document.getElementById('signupToggle').classList.add('active');
        }
        
        async function handleSignup(e) {
            e.preventDefault();
            
            const pharmacyCode = document.getElementById('signupPharmacyCode').value.toUpperCase();
            const pharmacyName = document.getElementById('signupPharmacyName').value.trim();
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            
            if (password !== passwordConfirm) {
                showModal(
                    '<span style="color: var(--danger);">❌ Error</span>',
                    '<p style="text-align: center; padding: 20px;">Passwords do not match!</p>',
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                );
                return;
            }
            
            if (password.length < 6) {
                showModal(
                    '<span style="color: var(--danger);">❌ Error</span>',
                    '<p style="text-align: center; padding: 20px;">Password must be at least 6 characters!</p>',
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                );
                return;
            }
            
            const signupBtn = document.getElementById('signupBtn');
            const signupBtnText = document.getElementById('signupBtnText');
            const signupBtnLoading = document.getElementById('signupBtnLoading');
            
            signupBtn.disabled = true;
            signupBtnText.style.display = 'none';
            signupBtnLoading.style.display = 'inline-block';
            
            try {
                const { data: existingPharmacy } = await supabaseClient
                    .from('pharmacies')
                    .select('pharmacy_code')
                    .eq('pharmacy_code', pharmacyCode)
                    .maybeSingle();
                
                if (existingPharmacy) {
                    showModal(
                        '<span style="color: var(--danger);">❌ Error</span>',
                        '<p style="text-align: center; padding: 20px;">This pharmacy code is already registered! Please choose another.</p>',
                        '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                    );
                    return;
                }
                
                const { data: newPharmacy, error } = await supabaseClient
                    .from('pharmacies')
                    .insert([{
                        pharmacy_code: pharmacyCode,
                        password_hash: password,
                        pharmacy_name: pharmacyName || 'Pharmacy ' + pharmacyCode
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showModal(
                    '<span style="color: var(--secondary);">✅ Success</span>',
                    '<p style="text-align: center; padding: 20px;">Account created successfully! Please login.</p>',
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal(); document.getElementById(\'loginPharmacyCode\').value = \'' + pharmacyCode + '\'; showLogin()">Login Now</button>'
                );
                
                document.getElementById('signupForm').reset();
                
            } catch (error) {
                console.error('Signup error:', error);
                showModal(
                    '<span style="color: var(--danger);">❌ Error</span>',
                    `<p style="text-align: center; padding: 20px;">Signup failed: ${error.message}</p>`,
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                );
            } finally {
                signupBtn.disabled = false;
                signupBtnText.style.display = 'inline';
                signupBtnLoading.style.display = 'none';
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const pharmacyCode = document.getElementById('loginPharmacyCode').value.toUpperCase();
            const password = document.getElementById('loginPassword').value;
            
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginBtnLoading = document.getElementById('loginBtnLoading');
            
            loginBtn.disabled = true;
            loginBtnText.style.display = 'none';
            loginBtnLoading.style.display = 'inline-block';
            
            try {
                const { data: pharmacy, error } = await supabaseClient
                    .from('pharmacies')
                    .select('*')
                    .eq('pharmacy_code', pharmacyCode)
                    .single();
                
                if (error || !pharmacy) {
                    throw new Error('Invalid pharmacy code or password');
                }
                
                if (pharmacy.password_hash !== password) {
                    throw new Error('Invalid pharmacy code or password');
                }
                
                currentUser = pharmacy;
                localStorage.setItem('monoCurrentUser', JSON.stringify(pharmacy));
                
                document.getElementById('pharmacyInfo').textContent = pharmacy.pharmacy_name || pharmacy.pharmacy_code;
                
                await loadPatientsFromSupabase();
                
                document.getElementById('authPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                initializeApp();
                
            } catch (error) {
                console.error('Login error:', error);
                showModal(
                    '<span style="color: var(--danger);">❌ Error</span>',
                    `<p style="text-align: center; padding: 20px;">Login failed: ${error.message}</p>`,
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                );
            } finally {
                loginBtn.disabled = false;
                loginBtnText.style.display = 'inline';
                loginBtnLoading.style.display = 'none';
            }
        }
        
        function handleLogout() {
            confirmAction('Are you sure you want to logout?', function() {
                currentUser = null;
                localStorage.removeItem('monoCurrentUser');
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('authPage').style.display = 'flex';
                document.getElementById('loginForm').reset();
                document.getElementById('signupForm').reset();
                showLogin();
            });
        }
        
     
async function savePatientToSupabase(patient) {
    try {
        const patientData = {
            pharmacy_id: currentUser.id,
            national_id: patient.nationalId,
            phone_number: patient.phoneNumber,
            dispensing_date: patient.dispensingDate,
            refill_period: patient.refillPeriod,
            next_refill_date: patient.nextRefillDate,
            general_note: patient.generalNote,
            imported: patient.imported,
            
            // 🔥 هذا هو التعديل المطلوب: حفظ تاريخ الاستيراد (Batch Timestamp)
            import_date: patient.importDate || null, 

            updated_at: new Date().toISOString()
        };
        
        let patientId;
        
        if (editingPatientId) {
            console.log(`📝 Updating patient: ${editingPatientId}`);
            
            const { data, error } = await supabaseClient
                .from('patients')
                .update(patientData)
                .eq('id', editingPatientId)
                .select()
                .single();
            
            if (error) throw error;
            patientId = data.id;
            
            // حذف Prescriptions القديمة
            await supabaseClient
                .from('prescriptions')
                .delete()
                .eq('patient_id', patientId);
            
            console.log(`✅ Patient updated: ${patientId}`);
            
        } else {
            console.log('➕ Adding new patient...');
            
            const { data, error } = await supabaseClient
                .from('patients')
                .insert([patientData])
                .select()
                .single();
            
            if (error) throw error;
            patientId = data.id;
            
            console.log(`✅ New patient added: ${patientId}`);
        }
        
        // إضافة Prescriptions الجديدة
        const prescriptionsData = patient.prescriptions.map(p => ({
            patient_id: patientId,
            prescription_number: p.number,
            note: p.note
        }));
        
        const { error: prescError } = await supabaseClient
            .from('prescriptions')
            .insert(prescriptionsData);
        
        if (prescError) throw prescError;
        
        return patientId;
        
    } catch (error) {
        console.error('❌ Error saving patient:', error);
        throw error;
    }
}
async function deletePatientFromSupabase(patientId) {
    try {
        console.log(`🗑️ Attempting to delete patient: ${patientId}`);
        
        const { error } = await supabaseClient
            .from('patients')
            .delete()
            .eq('id', patientId);
        
        if (error) throw error;
        
        console.log(`✅ Patient deleted successfully from DB: ${patientId}`);
        
    } catch (error) {
        console.error('❌ Error deleting patient:', error);
        throw error;
    }
}
// ============================================
// DELETE PATIENT (OPTIMIZED)
// ============================================
async function deletePatient(patientId) {
    confirmAction('Are you sure you want to delete this patient?', async function () {
        // 1. إغلاق النافذة فوراً
        closeModal();
        
        try {
            console.log(`🗑️ Deleting patient: ${patientId}`);
            
            // 2. الحذف من السيرفر (Supabase)
            await deletePatientFromSupabase(patientId);
            
            // 3. الحذف من المصفوفة المحلية فوراً (عشان التحديث اللحظي)
            patients = patients.filter(p => p.id !== patientId);
            
            // 4. حذف من طابور الصرف إذا كان موجوداً فيه
            dispensingQueue = dispensingQueue.filter(p => p.id !== patientId);
            
            // 5. تحديث العدادات (Total, Today, etc.)
            updateStats();
            
            // 6. إعادة رسم الجداول
            displayPatients();
            renderDispensingQueue();
            
            console.log(`✅ Total patients after delete: ${patients.length}`);
            
            // 7. رسالة نجاح
            setTimeout(function () {
                let successHTML = `
                    <div style="text-align: center; padding: 30px">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #00B894, #00D2A0); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(0, 184, 148, 0.3);">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <p style="font-size: 18px; font-weight: 700; color: var(--dark); margin-bottom: 8px">Deleted Successfully! 🗑️</p>
                        <p style="font-size: 14px; color: #636E72;">Total Patients: ${patients.length}</p>
                    </div>
                `;
                showModal(
                    '<span style="color: var(--secondary);">✅ SUCCESS</span>',
                    successHTML,
                    '<button class="btn-primary" style="grid-column: 1/3" onclick="closeModal()">OK</button>'
                );
                // إغلاق تلقائي بعد 1.5 ثانية
                setTimeout(() => closeModal(), 1500);
            }, 300);
            
        } catch (error) {
            console.error('❌ Delete error:', error);
            showModal(
                '<span style="color: var(--danger);">❌ ERROR</span>',
                `<p style="text-align: center; padding: 20px;">فشل الحذف: ${error.message}</p>`,
                '<button class="btn-primary" style="grid-column: 1/3" onclick="closeModal()">OK</button>'
            );
        }
    });
}

// ============================================
// ACTUAL SAVE PATIENT (تم التعديل لإصلاح البحث والتحديث)
// ============================================
async function actualSavePatient(patient) {
    const saveBtn = document.getElementById('saveBtn');
    const saveButtonText = document.getElementById('saveButtonText');
    const originalText = saveButtonText.textContent;
    
    saveBtn.disabled = true;
    saveButtonText.textContent = editingPatientId ? 'UPDATING...' : 'SAVING...';
    
    try {
        console.log(`💾 ${editingPatientId ? 'Updating' : 'Saving'} patient...`);
        
        // 1. حفظ في Database
        await savePatientToSupabase(patient);
        
        // 2. إعادة تحميل من Database (لجلب البيانات الجديدة + التحديثات)
        await loadPatientsFromSupabase();
        
        // 3. 🔥 تحديث محرك البحث يدوياً هنا لضمان ظهور الاسم فوراً 🔥
        if (window.Fuse) {
            fuse = new Fuse(patients, {
                keys: [
                    'nationalId', 
                    'phoneNumber', 
                    'generalNote',
                    'prescriptions.number', 
                    'prescriptions.note'
                ],
                threshold: 0.0,
                ignoreLocation: true,
                useExtendedSearch: true
            });
            console.log("🔍 Search Engine Force Updated after Save!");
        }

        // 4. تحديث العدادات والواجهة
        updateStats();
        displayPatients();
        
        console.log(`✅ Total patients after save: ${patients.length}`);
        
        // 5. رسالة نجاح
        showModal(
            '<span style="color: var(--secondary)">✅ Success</span>',
            `<p style="text-align: center; padding: 20px">تم ${editingPatientId ? 'تحديث' : 'إضافة'} المريض بنجاح! 💊<br><small style="color: #636E72;">Total: ${patients.length}</small></p>`,
            '<button class="btn-primary" style="grid-column: 1/3" onclick="closeModal(); switchTab(\'patients\')">عرض المرضى</button>'
        );
        
        // 6. إعادة تعيين النموذج
        resetForm();
        editingPatientId = null;
        
    } catch (error) {
        console.error('❌ Save error:', error);
        showModal(
            '<span style="color: var(--danger)">❌ Error</span>',
            `<p style="text-align: center; padding: 20px">فشل الحفظ: ${error.message}</p>`,
            '<button class="btn-primary" style="grid-column: 1/3" onclick="closeModal()">OK</button>'
        );
    } finally {
        saveBtn.disabled = false;
        saveButtonText.textContent = originalText;
    }
}

// ============================================
// APP INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    const savedUser = localStorage.getItem('monoCurrentUser');
    
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        
        // عرض اسم الصيدلية
        const pharmacyInfoElement = document.getElementById('pharmacyInfo');
        if (pharmacyInfoElement) {
            pharmacyInfoElement.textContent = currentUser.pharmacy_name || currentUser.pharmacy_code;
        }

        document.getElementById('authPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        
        console.log('🚀 Initializing app...');
        
        // تحميل البيانات وبدء التطبيق
        loadPatientsFromSupabase().then(() => {
            console.log('📱 Loading UI components...');
            
            // تهيئة القوائم والعرض
            initializeApp();
            displayPatients();
            renderDispensingQueue();
            
            console.log('✅ App initialized successfully');
        }).catch(error => {
            console.error('❌ App initialization failed:', error);
        });
    }
});
      function initializeApp() {
            // 1. الإعدادات الأولية للعناصر
            document.getElementById('dispensingDate').valueAsDate = new Date();
            addPrescription();
            
            // 2. تفعيل المستمعين (Event Listeners)
            document.getElementById('dispensingDate').addEventListener('change', calculateNextRefill);
            document.getElementById('searchInput').addEventListener('input', searchPatients);
            document.getElementById('filterDateFrom').addEventListener('change', applyDateFilter);
            document.getElementById('filterDateTo').addEventListener('change', applyDateFilter);
            document.getElementById('importFile').addEventListener('change', handleImportFile);
            document.getElementById('importFileData').addEventListener('change', handleImportFile);
            
            // التحقق من التكرار عند الخروج من حقل الهوية
            document.getElementById('nationalId').addEventListener('blur', checkIDDuplicate);
            
            // 3. العرض الأولي للبيانات
            calculateNextRefill();
            displayPatients();

            // ============================================================
            // 🆕 التعديل الجديد: تفعيل المزامنة اللحظية (Realtime Sync)
            // ============================================================
            if (currentUser) {
                console.log('🟢 Connecting to Realtime updates...');
                
                const subscription = supabaseClient
                    .channel('public:patients') // قناة استماع عامة لجدول المرضى
                    .on(
                        'postgres_changes', 
                        { event: '*', schema: 'public', table: 'patients' }, // الاستماع لأي تغيير (إضافة، حذف، تعديل)
                        (payload) => {
                            console.log('🔄 Change detected from another device:', payload);
                            
                            // عند حدوث أي تغيير، نقوم بإعادة تحميل البيانات وتحديث الشاشة
                            loadPatientsFromSupabase().then(() => {
                                displayPatients();
                                
                                // (اختياري) عرض تنبيه صغير يخبرك أن هناك تحديثاً حدث
                                // showModal('Updated', 'Data has been updated from another device', 'OK'); 
                            });
                        }
                    )
                    .subscribe();
            }
        }
        
        async function checkIDDuplicate() {
            const nationalId = document.getElementById('nationalId').value.trim();
            if (!nationalId || editingPatientId) return;
            
            const duplicates = patients.filter(p => p.nationalId === nationalId);
            if (duplicates.length > 0) {
                showDuplicatesModal(duplicates, nationalId, []);
            }
        }
        
        function selectRefill(days) {
            selectedRefillDays = days;
            document.querySelectorAll('.refill-box').forEach(box => {
                box.classList.remove('active');
            });
            event.target.closest('.refill-box').classList.add('active');
            calculateNextRefill();
        }
        
        function calculateNextRefill() {
            let dispensingDate = document.getElementById('dispensingDate').value;
            if (dispensingDate) {
                let date = new Date(dispensingDate);
                date.setDate(date.getDate() + selectedRefillDays);
                document.getElementById('nextRefillDate').value = date.toISOString().split('T')[0];
            }
        }
        
        function addPrescription() {
            let container = document.getElementById('prescriptionsContainer');
            let index = container.children.length;
            
            let prescriptionDiv = document.createElement('div');
            prescriptionDiv.className = 'prescription-item';
            prescriptionDiv.setAttribute('data-index', index);
            prescriptionDiv.innerHTML = `
                ${index > 0 ? '<button class="remove-btn" onclick="removePrescription(' + index + ')">×</button>' : ''}
                <div class="form-group">
                    <label class="form-label">
                        <div class="icon icon-pill" style="background: var(--primary);"></div>
                        Prescription Number (Letter + 7 Digits)
                    </label>
                    <input type="text" class="form-input prescription-number" placeholder="a1234567" maxlength="8" pattern="[a-z][0-9]{7}" onblur="checkPrescriptionDuplicate(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span style="font-size: 18px; margin-right: 8px;">📝</span>
                        Note (Optional)
                    </label>
                    <textarea class="form-input prescription-note" rows="2" placeholder="Optional notes..."></textarea>
                </div>
            `;
            
            container.appendChild(prescriptionDiv);
        }
    function checkPrescription(nationalId, prescriptionNumber) {
    // التعديل هنا: تم إضافة مسافة فارغة " " بين رقم الهوية ورقم الوصفة
    const combinedData = nationalId + " " + prescriptionNumber;
    
    // نسخ للـ Clipboard
    navigator.clipboard.writeText(combinedData).then(() => {
        // فتح الموقع
        window.open('https://ul.wasfaty.sa/support', '_blank');
        
        // عرض رسالة نجاح
        showModal(
            '<span style="color: var(--secondary);">✅ تم النسخ والفتح</span>',
            `
            <div style="text-align: center; padding: 25px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #00B894, #00D2A0); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(0, 184, 148, 0.3); animation: scaleIn 0.5s ease;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <p style="font-size: 18px; font-weight: 700; color: var(--dark); margin-bottom: 12px;">تم النسخ بنجاح!</p>
                
                <div style="background: linear-gradient(135deg, #F8F9FE, #E3E8FF); padding: 20px; border-radius: 16px; margin: 20px 0; border: 2px solid #6C5CE7;">
                    <p style="font-size: 13px; color: #636E72; margin-bottom: 10px; font-weight: 600;">البيانات المنسوخة:</p>
                    <div style="background: white; padding: 15px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 16px; font-weight: 700; color: #2D3436; word-break: break-all; border: 2px solid #DFE6E9;">
                        ${combinedData}
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #FFF9E6; border-radius: 8px; border-right: 4px solid #FFA502;">
                        <p style="font-size: 12px; color: #636E72; margin: 0; text-align: right; direction: rtl; line-height: 1.6;">
                            <strong style="color: #6C5CE7;">رقم الهوية:</strong> ${nationalId}<br>
                            <strong style="color: #6C5CE7;">رقم الوصفة:</strong> ${prescriptionNumber}
                        </p>
                    </div>
                </div>
                
                <p style="font-size: 13px; color: #636E72; line-height: 1.6;">
                    تم فتح موقع وصفتي 🌐<br>
                    الصق البيانات (Ctrl+V) في الحقل المطلوب
                </p>
            </div>
            `,
            '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">تمام ✅</button>'
        );
        
    }).catch(err => {
        console.error('Copy failed:', err);
        
        // في حالة فشل النسخ
        showModal(
            '<span style="color: var(--danger);">❌ خطأ</span>',
            `
            <div style="text-align: center; padding: 20px;">
                <p style="font-size: 16px; color: #636E72;">فشل النسخ! حاول مرة أخرى</p>
                <div style="background: #F8F9FE; padding: 15px; border-radius: 12px; margin-top: 15px; font-family: 'Courier New', monospace; font-weight: 700;">
                    ${combinedData}
                </div>
            </div>
            `,
            '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">حسناً</button>'
        );
        
        // فتح الموقع حتى لو فشل النسخ
        window.open('https://ul.wasfaty.sa/support', '_blank');
    });
}

        function removePrescription(index) {
            let container = document.getElementById('prescriptionsContainer');
            if (container.children.length > 1) {
                let item = container.querySelector(`[data-index="${index}"]`);
                if (item) {
                    item.remove();
                }
            } else {
                showModal(
                    '<span style="color: var(--warning);">⚠️ Warning</span>',
                    '<p style="text-align: center; padding: 20px;">At least one prescription is required!</p>',
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                );
            }
        }
        
        function generateQRCode(text) {
            try {
                let qr = qrcode(0, 'M');
                qr.addData(text);
                qr.make();
                return qr.createDataURL(4, 0);
            } catch (e) {
                console.error('QR Generation Error:', e);
                return null;
            }
        }
        
        function createQRElement(text, label, value) {
            let qrBox = document.createElement('div');
            qrBox.className = 'qr-box';
            
            let labelDiv = document.createElement('div');
            labelDiv.className = 'qr-label';
            labelDiv.textContent = label;
            qrBox.appendChild(labelDiv);
            
            let qrDataUrl = generateQRCode(text);
            if (qrDataUrl) {
                let img = document.createElement('img');
                img.src = qrDataUrl;
                img.width = 120;
                img.height = 120;
                qrBox.appendChild(img);
            }
            
            let valueDiv = document.createElement('div');
            valueDiv.className = 'qr-value';
            valueDiv.textContent = value;
            qrBox.appendChild(valueDiv);
            
            return qrBox;
        }
        
        async function savePatient() {
            let nationalId = document.getElementById('nationalId').value.trim();
            let phoneNumber = document.getElementById('phoneNumber').value.trim();
            let dispensingDate = document.getElementById('dispensingDate').value;
            let nextRefillDate = document.getElementById('nextRefillDate').value;
            
            if (!/^[1-4][0-9]{9}$/.test(nationalId)) {
                showModal(
                    '<span style="color: var(--danger);">❌ Error</span>',
                    '<p style="text-align: center; padding: 20px;">Invalid ID Number!</p>',
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                );
                return;
            }
            
            if (!dispensingDate) {
                showModal(
                    '<span style="color: var(--danger);">❌ Error</span>',
                    '<p style="text-align: center; padding: 20px;">Please select dispensing date</p>',
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                );
                return;
            }
            
            let prescriptions = [];
            let prescriptionItems = document.querySelectorAll('.prescription-item');
            
            for (let item of prescriptionItems) {
                let number = item.querySelector('.prescription-number').value.trim();
                if (!number) continue;
                
                if (!/^[a-z][0-9]{7}$/.test(number)) {
                    showModal(
                        '<span style="color: var(--danger);">❌ Error</span>',
                        '<p style="text-align: center; padding: 20px;">Invalid prescription number!</p>',
                        '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                    );
                    return;
                }
                
                prescriptions.push({
                    number: number,
                    note: item.querySelector('.prescription-note').value.trim()
                });
            }
            
            if (prescriptions.length === 0) {
                showModal(
                    '<span style="color: var(--danger);">❌ Error</span>',
                    '<p style="text-align: center; padding: 20px;">Please add at least one prescription</p>',
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                );
                return;
            }
            
            let patient = {
                nationalId: nationalId,
                phoneNumber: phoneNumber,
                dispensingDate: dispensingDate,
                refillPeriod: selectedRefillDays,
                nextRefillDate: nextRefillDate,
                prescriptions: prescriptions,
                generalNote: document.getElementById('generalNote').value.trim(),
                imported: false,
                createdAt: editingPatientId ? patients.find(p => p.id === editingPatientId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Check for duplicates (if not editing)
            if (!editingPatientId) {
                const prescriptionNumbers = prescriptions.map(p => p.number);
                const hasDuplicates = await checkDuplicates(nationalId, prescriptionNumbers);
                
                if (hasDuplicates) {
                    pendingSaveData = patient;
                    return;
                }
            }
            
            actualSavePatient(patient);
        }
       
        
        function resetForm() {
            editingPatientId = null;
            document.getElementById('nationalId').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('dispensingDate').valueAsDate = new Date();
            document.getElementById('generalNote').value = '';
            document.getElementById('prescriptionsContainer').innerHTML = '';
            document.getElementById('saveButtonText').textContent = 'ADD PATIENT';
            selectedRefillDays = 24;
            
            document.querySelectorAll('.refill-box').forEach(box => {
                box.classList.remove('active');
                if (box.getAttribute('data-days') === '24') {
                    box.classList.add('active');
                }
            });
            
            addPrescription();
            calculateNextRefill();
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'patients') {
                displayPatients();
            }
        }
      function displayPatients() {
    updateStats();
    
    let searchTerm = document.getElementById('searchInput').value.trim();
    let container = document.getElementById('patientsContainer');
    container.innerHTML = ''; // تنظيف الحاوية

    // 1. أولاً: نحدد القائمة بناءً على التاب المختار (All, Today, Imported...)
    let filteredPatients = filterPatientsByStatus(currentFilter);

    // 2. ثانياً: نطبق فلتر التاريخ (Date Range) إذا كان مفعلاً
    if (dateFilterActive && dateFilterFrom && dateFilterTo) {
        filteredPatients = filteredPatients.filter(p => {
            let refillDate = new Date(p.nextRefillDate);
            refillDate.setHours(0, 0, 0, 0);
            return refillDate >= dateFilterFrom && refillDate <= dateFilterTo;
        });
    }

    // 3. ثالثاً: نطبق البحث (Search) على القائمة المفلترة حالياً
    // هذا يضمن أن البحث يتم "داخل" الفلتر المختار
    if (fuse && searchTerm) {
        let fuseResults = fuse.search(searchTerm);
        let searchIds = fuseResults.map(r => r.item.id);
        
        // احتفظ فقط بالمرضى الذين: (هم في الفلتر الحالي) و (موجودين في نتائج البحث)
        filteredPatients = filteredPatients.filter(p => searchIds.includes(p.id));
    }

    // --- (مرحلة الرسم) Rendering ---

    // حالة عدم وجود نتائج
    if (filteredPatients.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <div class="no-data-icon">
                    <div class="icon icon-search" style="width: 40px; height: 40px; border-width: 4px; color: #B2BEC3; margin: 0 auto;"></div>
                </div>
                <p style="font-size: 18px; font-weight: 700; color: #95A5A6;">
                    ${searchTerm ? 'No matching results in this list' : 'No patients found'}
                </p>
            </div>
        `;
        return;
    }

    // منطق العرض الخاص بقسم Imported (على شكل مجموعات/Boxes)
    // يظهر فقط إذا كنا في تاب Imported + لا يوجد بحث نشط (عشان البحث بيحب القائمة تكون تحت بعض)
    if (currentFilter === 'imported' && !searchTerm && !dateFilterActive) {
        
        const batches = {};
        
        filteredPatients.forEach(p => {
            const key = p.importDate || 'Manual / Old Entry';
            if (!batches[key]) batches[key] = [];
            batches[key].push(p);
        });

        const sortedKeys = Object.keys(batches).sort((a, b) => {
            if (a.includes('Manual')) return 1;
            if (b.includes('Manual')) return -1;
            return new Date(b) - new Date(a);
        });

        sortedKeys.forEach(dateKey => {
            const batchList = batches[dateKey];
            let displayHeader = dateKey;
            
            if (!dateKey.includes('Manual')) {
                const d = new Date(dateKey);
                if (!isNaN(d)) {
                    const dateStr = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timeStr = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    displayHeader = `
                        <div style="display:flex; gap:15px; align-items:center;">
                            <span>📅 ${dateStr}</span>
                            <span style="background:rgba(255,255,255,0.15); padding:2px 8px; border-radius:4px; font-size:11px;">
                                🕒 ${timeStr}
                            </span>
                        </div>
                    `;
                }
            } else {
                displayHeader = `📁 Manual / Old Entry`;
            }

            const batchBox = document.createElement('div');
            batchBox.className = 'import-batch-container';
            batchBox.innerHTML = `
                <div class="import-batch-header">
                    <div style="font-size:14px; font-weight:bold;">
                        ${displayHeader}
                    </div>
                    <div style="background:#00B894; color:white; padding:3px 10px; border-radius:12px; font-size:11px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                        ${batchList.length} Cards
                    </div>
                </div>
                <div class="import-batch-grid"></div>
            `;

            const grid = batchBox.querySelector('.import-batch-grid');
            batchList.forEach(patient => {
                grid.appendChild(createPatientCard(patient, searchTerm));
            });

            container.appendChild(batchBox);
        });

    } else {
        // 🔥 العرض العادي (لباقي التابات: All, Today, etc. أو عند البحث)
        filteredPatients.forEach(patient => {
            let card = createPatientCard(patient, searchTerm);
            container.appendChild(card);
        });
    }
}
        // دالة مساعدة لعمل Highlight للنص
function highlightMatch(text, searchTerm) {
    if (!text) return '';
    if (!searchTerm || searchTerm.trim() === '') return text;

    // تنظيف النص وتجهيز البحث (Case Insensitive)
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.toString().replace(regex, '<span class="highlight-text">$1</span>');
}
function createPatientCard(patient, searchTerm = '') {
    let card = document.createElement('div');
    card.className = 'patient-card';
    
    // 1. تحديد حالة الريفيل وتنسيق الكروت المستوردة
    let status = getRefillStatus(patient.nextRefillDate);
    if (status) card.classList.add(status);
    if (patient.imported) card.classList.add('imported');
    
    let badgeText = status === 'today' ? 'DUE TODAY' : 
                    status === 'overdue' ? 'OVERDUE' : 
                    status === 'upcoming' ? 'UPCOMING' : 'SCHEDULED';

    // 2. تجهيز رابط الواتساب
    let whatsappLink = '';
    if (patient.phoneNumber) {
        let cleanPhone = patient.phoneNumber.replace(/\D/g, '');
        if (cleanPhone.startsWith('05')) {
            cleanPhone = '966' + cleanPhone.substring(1);
        }
        whatsappLink = `https://wa.me/${cleanPhone}`;
    }
// 3. دالة لمعالجة النوت وتحويل الكلمات إلى بادجات ملونة
    const processNotes = (note) => {
        if (!note) return '';
        
        let badgesHtml = '<div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:6px;">';
        
        // تقسيم النص بناءً على الفواصل لإنشاء صناديق منفصلة
        // مثلاً: "VIP, SENSOR, مريض مستعجل" -> ستصبح 3 صناديق
        let parts = note.split(',').map(s => s.trim()).filter(s => s.length > 0);

        // تعريف الكلمات الخاصة وألوانها
        const tagsMap = {
            'VIP': { class: 'badge-vip', icon: '' }, // الـ VIP الجديد
            'NEED NEW RX NO': { class: 'badge-need-rx', icon: '⚠️' },
            'SENSOR': { class: 'badge-sensor', icon: '📡' },
            'INSULIN': { class: 'badge-insulin', icon: '💉' },
            'NO ANSWER': { class: 'badge-no-answer', icon: '📞' },
            'REJECTED': { class: 'badge-rejected', icon: '❌' },
            'DISPENSED': { class: 'badge-dispensed', icon: '✅' }
        };

        parts.forEach(part => {
            let cssClass = 'badge-default'; // اللون الأزرق الافتراضي لأي نص يدوي
            let icon = ''; 
            let textToShow = part;

            // البحث هل النص يحتوي على كلمة مفتاحية من القائمة أعلاه؟
            // تم استخدام Object.keys للبحث بذكاء
            for (const [key, config] of Object.entries(tagsMap)) {
                if (part.toUpperCase().includes(key)) {
                    cssClass = config.class;
                    // إذا لم يكن النص يحتوي على الأيقونة بالفعل، نستخدم أيقونة التاج
                    if (!part.includes(config.icon) && config.icon) {
                        // icon = config.icon; // يمكن تفعيل هذا إذا أردت فصل الأيقونة
                    }
                    break; 
                }
            }

            // إنشاء البوكس (الصندوق)
            badgesHtml += `<span class="note-badge ${cssClass}" style="font-size: 11px; padding: 5px 12px;">${highlightMatch(textToShow, searchTerm)}</span>`;
        });
        
        badgesHtml += '</div>';
        return badgesHtml;
    };
    // 4. تطبيق الـ Highlight على النصوص الأساسية
    const hl_nationalId = highlightMatch(patient.nationalId, searchTerm);
    const hl_phone = highlightMatch(patient.phoneNumber, searchTerm);

    // 5. بناء كود HTML للكارت
    card.innerHTML = `
        <div class="patient-header">
            <div>
                <div class="patient-id">${hl_nationalId}</div>
                
                ${patient.phoneNumber ? `
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                    <div class="patient-phone" style="color: #636E72; font-weight: 600;">
                        📱 ${hl_phone}
                    </div>

                    <a href="tel:${patient.phoneNumber}" title="اتصال هاتفي" style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: #0984e3; border-radius: 50%; color: white; box-shadow: 0 2px 5px rgba(9, 132, 227, 0.3); transition: transform 0.2s; text-decoration: none;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                    </a>

                    <a href="${whatsappLink}" target="_blank" title="مراسلة واتساب" style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: #25D366; border-radius: 50%; color: white; box-shadow: 0 2px 5px rgba(37, 211, 102, 0.3); transition: transform 0.2s; text-decoration: none;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                        </svg>
                    </a>
                </div>
                ` : ''}

            </div>
            <div class="patient-badge">${badgeText}</div>
        </div>
        
        <div class="patient-info">
            <strong>Dispensing Date:</strong> ${patient.dispensingDate}<br>
            <strong>Next Refill:</strong> ${patient.nextRefillDate}
            <span class="date-badge ${status}">${getDaysUntilRefill(patient.nextRefillDate)}</span>
        </div>

        <div class="prescriptions-list">
            <strong style="font-size: 11px; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px;">Prescriptions (${patient.prescriptions.length}):</strong><br>
            ${patient.prescriptions.map(p => `
                <div style="display: inline-flex; align-items: center; gap: 6px; margin: 5px 5px 5px 0; background: white; padding: 4px 8px; border-radius: 8px; border: 2px solid #E3E8FF;">
                    <span class="prescription-tag" style="margin: 0; border: none; padding: 4px 10px;">
                        ${highlightMatch(p.number, searchTerm)}
                    </span>
                    ${p.note ? `<span style="font-size:11px; color:#666;">(${highlightMatch(p.note, searchTerm)})</span>` : ''}
                    
                    <button class="btn-copy-only" onclick="copyRxOnly('${patient.nationalId}', '${p.number}')" title="نسخ فقط">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>

                    <button class="btn-check-wasfaty" onclick="checkPrescription('${patient.nationalId}', '${p.number}')" title="نسخ وفتح وصفتي">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </button>
                </div>
            `).join('')}
        </div>
        
        ${patient.generalNote ? `
            <div class="info-box" style="background: #FFF9C4; border-left: 4px solid #FBC02D; color: #333;">
                ${processNotes(patient.generalNote)}
            </div>
        ` : ''}
        
        <div class="qr-display" id="qr-${patient.id}"></div>
        
        <div class="patient-actions">
            <button class="btn-action btn-edit" onclick="editPatient('${patient.id}')" data-tooltip="Edit">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>
            <button class="btn-action btn-delete" onclick="deletePatient('${patient.id}')" data-tooltip="Delete">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            </button>
            <button class="btn-action btn-whatsapp" onclick="shareWhatsApp('${patient.id}')" data-tooltip="Share Card">
               <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                   <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
               </svg>
            </button>
        </div>
    `;
    
    // حل مشكلة تكرار الكيو ار (تنظيف الحاوية قبل الإضافة)
    setTimeout(() => {
        let qrContainer = document.getElementById('qr-' + patient.id);
        if (qrContainer) {
            qrContainer.innerHTML = ''; // هذا السطر يمنع التكرار
            
            qrContainer.appendChild(createQRElement(patient.nationalId, 'ID', patient.nationalId));
            patient.prescriptions.forEach((presc, idx) => {
                qrContainer.appendChild(createQRElement(presc.number, 'RX ' + (idx + 1), presc.number));
            });
        }
    }, 100);
    
    return card;
}
        function getRefillStatus(nextRefillDate) {
            let today = new Date();
            today.setHours(0, 0, 0, 0);
            let refillDate = new Date(nextRefillDate);
            refillDate.setHours(0, 0, 0, 0);
            let diff = Math.floor((refillDate - today) / (1000 * 60 * 60 * 24));
            
            if (diff < 0) return 'overdue';
            if (diff === 0) return 'today';
            if (diff <= 7) return 'upcoming';
            return null;
        }
        
        function getDaysUntilRefill(nextRefillDate) {
            let today = new Date();
            today.setHours(0, 0, 0, 0);
            let refillDate = new Date(nextRefillDate);
            refillDate.setHours(0, 0, 0, 0);
            let diff = Math.floor((refillDate - today) / (1000 * 60 * 60 * 24));
            
            if (diff < 0) return `${Math.abs(diff)} days overdue`;
            if (diff === 0) return 'Today';
            if (diff === 1) return 'Tomorrow';
            return `In ${diff} days`;
        }
     function updateStats() {
    console.log('📊 Updating Stats...');
    
    // 1. حساب الإحصائيات (Calculations)
    let today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // التعديل الأساسي هنا:
    // نستخدم المتغير العالمي totalRealCount (اللي جبناه من الداتا بيز)
    // لو لسه بصفر (أول تحميل)، نستخدم طول المصفوفة مؤقتاً
    let total = totalRealCount > 0 ? totalRealCount : patients.length;
    
    // باقي العدادات بتتحسب من البيانات المحملة (لأنها بتعتمد على التواريخ)
    // ملحوظة: العدادات الفرعية (Today/Overdue) هتكون دقيقة للبيانات المحملة فقط (أول 2000 مريض)
    let todayCount = patients.filter(p => {
        let refillDate = new Date(p.nextRefillDate);
        refillDate.setHours(0, 0, 0, 0);
        return refillDate.getTime() === today.getTime();
    }).length;
    
    let upcomingCount = patients.filter(p => {
        let refillDate = new Date(p.nextRefillDate);
        refillDate.setHours(0, 0, 0, 0);
        let diff = Math.floor((refillDate - today) / (1000 * 60 * 60 * 24));
        return diff > 0 && diff <= 7;
    }).length;
    
    let overdueCount = patients.filter(p => {
        let refillDate = new Date(p.nextRefillDate);
        refillDate.setHours(0, 0, 0, 0);
        return refillDate < today;
    }).length;
    
    console.log(`📊 Calculated: Total=${total} (Real Count), Today=${todayCount}, Upcoming=${upcomingCount}, Overdue=${overdueCount}`);
    
    // 2. تحديث الواجهة (Smart DOM Update)
    const statsGrid = document.getElementById('statsGrid');
    
    if (statsGrid) {
        // التحقق: هل الكروت موجودة أصلاً؟
        if (statsGrid.children.length === 0) {
            // الحالة أ: الكروت مش موجودة -> نرسمها لأول مرة ونضيف IDs للأرقام
            statsGrid.innerHTML = `
                <div class="stat-card total" onclick="filterPatients('all')">
                    <div class="number" id="val-total">${total}</div>
                    <div class="label">Total Patients</div>
                </div>
                <div class="stat-card today" onclick="filterPatients('today')">
                    <div class="number" id="val-today">${todayCount}</div>
                    <div class="label">Due Today</div>
                </div>
                <div class="stat-card upcoming" onclick="filterPatients('upcoming')">
                    <div class="number" id="val-upcoming">${upcomingCount}</div>
                    <div class="label">Upcoming Week</div>
                </div>
                <div class="stat-card overdue" onclick="filterPatients('overdue')">
                    <div class="number" id="val-overdue">${overdueCount}</div>
                    <div class="label">Overdue</div>
                </div>
            `;
        } else {
            // الحالة ب: الكروت موجودة -> نحدث الأرقام فقط (بدون إعادة رسم)
            try {
                // نستخدم innerText للتأكد من التحديث الفوري
                const elTotal = document.getElementById('val-total');
                if(elTotal) elTotal.innerText = total; 
                
                const elToday = document.getElementById('val-today');
                if(elToday) elToday.innerText = todayCount;
                
                const elUpcoming = document.getElementById('val-upcoming');
                if(elUpcoming) elUpcoming.innerText = upcomingCount;
                
                const elOverdue = document.getElementById('val-overdue');
                if(elOverdue) elOverdue.innerText = overdueCount;
                
            } catch (e) {
                console.error("Error updating stat values directly", e);
                // Fallback: لو حصل مشكلة، نعيد الرسم
                statsGrid.innerHTML = ""; 
                updateStats(); 
            }
        }
    }

    // 3. تحديث محرك البحث (Fuse.js)
    if (window.Fuse) {
        fuse = new Fuse(patients, {
            keys: [
                'nationalId', 
                'phoneNumber', 
                'generalNote',
                'prescriptions.number', 
                'prescriptions.note'
            ],
            threshold: 0.0,
            ignoreLocation: true,
            useExtendedSearch: true
        });
        console.log('🔍 Fuse search engine re-indexed');
    }
}
        function filterPatientsByStatus(status) {
            let today = new Date();
            today.setHours(0, 0, 0, 0);
            
            switch(status) {
                case 'all':
                    return [...patients];
                case 'today':
                    return patients.filter(p => {
                        let refillDate = new Date(p.nextRefillDate);
                        refillDate.setHours(0, 0, 0, 0);
                        return refillDate.getTime() === today.getTime();
                    });
                case 'upcoming':
                    return patients.filter(p => {
                        let refillDate = new Date(p.nextRefillDate);
                        refillDate.setHours(0, 0, 0, 0);
                        let diff = Math.floor((refillDate - today) / (1000 * 60 * 60 * 24));
                        return diff > 0 && diff <= 7;
                    });
                case 'overdue':
                    return patients.filter(p => {
                        let refillDate = new Date(p.nextRefillDate);
                        refillDate.setHours(0, 0, 0, 0);
                        return refillDate < today;
                    });
                case 'imported':
                    return patients.filter(p => p.imported);
                default:
                    return [...patients];
            }
        }
   function filterPatients(status) {
    currentFilter = status;
    
    document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
    
    // Find the chip button by its text content
    let chips = document.querySelectorAll('.chip');
    chips.forEach(chip => {
        let chipText = chip.textContent.trim().toLowerCase();
        if ((status === 'all' && chipText === 'all') ||
            (status === 'today' && chipText === 'due today') ||
            (status === 'upcoming' && chipText === 'upcoming week') ||
            (status === 'overdue' && chipText === 'overdue') ||
            (status === 'imported' && chipText === 'imported')) {
            chip.classList.add('active');
        }
    });
    
    displayPatients();
}

        
        function searchPatients() {
            displayPatients();
        }
        
     // متغير عشان نحفظ حالة الفلترة بالتاريخ
let dateFilterActive = false;
let dateFilterFrom = null;
let dateFilterTo = null;

function applyDateFilter() {
    let dateFrom = document.getElementById('filterDateFrom').value;
    let dateTo = document.getElementById('filterDateTo').value;
    
    if (!dateFrom || !dateTo) {
        dateFilterActive = false;
        dateFilterFrom = null;
        dateFilterTo = null;
        displayPatients();
        return;
    }
    
    dateFilterActive = true;
    dateFilterFrom = new Date(dateFrom);
    dateFilterTo = new Date(dateTo);
    
    // استدعاء displayPatients عشان تتكامل مع الفلاتر التانية
    displayPatients();
}

        function displayFilteredPatients(filteredPatients) {
            let container = document.getElementById('patientsContainer');
            
            if (filteredPatients.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">
                            <div class="icon icon-search" style="width: 40px; height: 40px; border-width: 4px; color: #B2BEC3; margin: 0 auto;"></div>
                        </div>
                        <p style="font-size: 18px; font-weight: 700; color: #95A5A6;">No results found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            filteredPatients.forEach(patient => {
                let card = createPatientCard(patient);
                container.appendChild(card);
            });
        }
        
        function editPatient(patientId) {
            let patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            editingPatientId = patientId;
            
            document.getElementById('nationalId').value = patient.nationalId;
            document.getElementById('phoneNumber').value = patient.phoneNumber;
            document.getElementById('dispensingDate').value = patient.dispensingDate;
            document.getElementById('nextRefillDate').value = patient.nextRefillDate;
            document.getElementById('generalNote').value = patient.generalNote;
            
            selectedRefillDays = patient.refillPeriod;
            document.querySelectorAll('.refill-box').forEach(box => {
                box.classList.remove('active');
                if (parseInt(box.getAttribute('data-days')) === patient.refillPeriod) {
                    box.classList.add('active');
                }
            });
            
            document.getElementById('prescriptionsContainer').innerHTML = '';
            patient.prescriptions.forEach((presc, idx) => {
                addPrescription();
                let items = document.querySelectorAll('.prescription-item');
                let item = items[items.length - 1];
                item.querySelector('.prescription-number').value = presc.number;
                item.querySelector('.prescription-note').value = presc.note;
            });
            
            document.getElementById('saveButtonText').textContent = 'UPDATE PATIENT';
            
            switchTab('add');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    
    async function shareWhatsApp(patientId) {
    let patient = patients.find(p => p.id === patientId);
    if (!patient) return;
    
    // Create a temporary container
    let tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    tempContainer.style.width = '600px';
    tempContainer.style.background = 'white';
    tempContainer.style.padding = '20px';
    document.body.appendChild(tempContainer);
    
    // Create patient card HTML
    let status = getRefillStatus(patient.nextRefillDate);
    let badgeText = status === 'today' ? 'DUE TODAY' : 
                   status === 'overdue' ? 'OVERDUE' : 
                   status === 'upcoming' ? 'UPCOMING' : 'SCHEDULED';
    
    tempContainer.innerHTML = `
        <div class="patient-card" style="width: 100%; max-width: 600px; background: white; border: 2px solid #DFE6E9; border-radius: 16px; padding: 20px; position: relative;">
            <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: linear-gradient(180deg, #6C5CE7, #54A0FF); border-radius: 16px 0 0 16px;"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; padding-left: 10px;">
                <div>
                    <div style="font-size: 24px; font-weight: 800; color: #2D3436; margin-bottom: 6px; font-family: 'Courier New', monospace;">${patient.nationalId}</div>
                    ${patient.phoneNumber ? `<div style="font-size: 14px; font-weight: 600; color: #636E72;">📱 ${patient.phoneNumber}</div>` : ''}
                </div>
                <div style="background: linear-gradient(135deg, #6C5CE7, #54A0FF); color: white; padding: 6px 14px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase;">${badgeText}</div>
            </div>
            
            <div style="font-size: 13px; color: #636E72; margin-bottom: 15px; padding-left: 10px; line-height: 1.8;">
                <strong style="color: #2D3436;">Dispensing Date:</strong> ${patient.dispensingDate}<br>
                <strong style="color: #2D3436;">Next Refill:</strong> ${patient.nextRefillDate}
                <span style="display: inline-block; background: #F8F9FE; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; margin-left: 8px;">${getDaysUntilRefill(patient.nextRefillDate)}</span>
            </div>
            
            <div style="background: #F8F9FE; padding: 15px; border-radius: 12px; margin: 15px 0;">
                <strong style="font-size: 11px; color: #6C5CE7; text-transform: uppercase; letter-spacing: 1px;">Prescriptions (${patient.prescriptions.length}):</strong><br>
                <div style="margin-top: 10px;">
                    ${patient.prescriptions.map(p => `<span style="display: inline-block; background: white; padding: 8px 14px; border-radius: 8px; margin: 5px 5px 5px 0; font-size: 12px; font-weight: 700; font-family: 'Courier New', monospace; border: 2px solid #E3E8FF;">${p.number}</span>`).join('')}
                </div>
            </div>
            
            ${patient.generalNote ? `<div style="background: #FFF9E6; padding: 12px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #FFA502;"><strong style="color: #2D3436;">Note:</strong> ${patient.generalNote}</div>` : ''}
            
            <div id="qrContainer" style="display: flex; gap: 12px; margin-top: 15px; flex-wrap: wrap; justify-content: center; background: white; padding: 15px; border-radius: 12px; border: 2px solid #F0F3FF;"></div>
        </div>
    `;
    
    // Generate QR codes
    let qrContainer = tempContainer.querySelector('#qrContainer');
    
    // Add ID QR
    let idQrBox = document.createElement('div');
    idQrBox.style.cssText = 'background: white; padding: 12px; border-radius: 12px; text-align: center; border: 2px solid #E3E8FF; box-shadow: 0 4px 12px rgba(0,0,0,0.05);';
    let idQr = qrcode(0, 'M');
    idQr.addData(patient.nationalId);
    idQr.make();
    idQrBox.innerHTML = `
        ${idQr.createImgTag(4, 8)}
        <div style="font-size: 10px; color: #6C5CE7; font-weight: 700; text-transform: uppercase; margin-top: 8px;">ID</div>
        <div style="font-size: 11px; color: #2D3436; font-weight: 700; font-family: 'Courier New', monospace; margin-top: 4px;">${patient.nationalId}</div>
    `;
    qrContainer.appendChild(idQrBox);
    
    // Add Prescription QRs
    patient.prescriptions.forEach((presc, idx) => {
        let prescQrBox = document.createElement('div');
        prescQrBox.style.cssText = 'background: white; padding: 12px; border-radius: 12px; text-align: center; border: 2px solid #E3E8FF; box-shadow: 0 4px 12px rgba(0,0,0,0.05);';
        let prescQr = qrcode(0, 'M');
        prescQr.addData(presc.number);
        prescQr.make();
        prescQrBox.innerHTML = `
            ${prescQr.createImgTag(4, 8)}
            <div style="font-size: 10px; color: #6C5CE7; font-weight: 700; text-transform: uppercase; margin-top: 8px;">RX ${idx + 1}</div>
            <div style="font-size: 11px; color: #2D3436; font-weight: 700; font-family: 'Courier New', monospace; margin-top: 4px;">${presc.number}</div>
        `;
        qrContainer.appendChild(prescQrBox);
    });
    
    // Wait a bit for QR codes to render
    setTimeout(async () => {
        try {
            // Take screenshot
            const canvas = await html2canvas(tempContainer, {
                backgroundColor: '#ffffff',
                scale: 2,
                logging: false,
                useCORS: true,
                width: 600,
                windowWidth: 600
            });
            
            // Convert to blob
            canvas.toBlob(async (blob) => {
                const file = new File([blob], `patient-${patient.nationalId}.png`, { type: 'image/png' });
                
                // Try native share API
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'Patient Card',
                            text: `Patient: ${patient.nationalId}\nNext Refill: ${patient.nextRefillDate}\n\nPrescriptions:\n${patient.prescriptions.map(p => '- ' + p.number).join('\n')}`
                        });
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.log('Share cancelled:', error);
                            fallbackWhatsAppShare(blob, patient);
                        }
                    }
                } else {
                    // Fallback to download + WhatsApp link
                    fallbackWhatsAppShare(blob, patient);
                }
                
                // Clean up
                document.body.removeChild(tempContainer);
                
            }, 'image/png', 1.0);
            
        } catch (error) {
            console.error('Screenshot error:', error);
            document.body.removeChild(tempContainer);
            
            showModal(
                '<span style="color: var(--danger);">❌ ERROR</span>',
                '<div style="text-align: center; padding: 30px;"><div style="width: 80px; height: 80px; background: linear-gradient(135deg, #FF6B6B, #EE5A6F); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(255, 107, 107, 0.3);"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div><p style="font-size: 18px; font-weight: 700; color: var(--dark); margin-bottom: 8px;">Screenshot Failed!</p><p style="font-size: 14px; color: #636E72;">' + error.message + '</p></div>',
                '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
            );
        }
    }, 800); // Increased delay to ensure QR codes are fully rendered
}

function fallbackWhatsAppShare(blob, patient) {
    // Create download link
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `patient-${patient.nationalId}.png`;
    link.click();
    
    // Open WhatsApp with text
    setTimeout(() => {
        const message = `*Patient Card* 🏥\n\n📋 ID: ${patient.nationalId}\n📅 Dispensing: ${patient.dispensingDate}\n🔄 Next Refill: ${patient.nextRefillDate}\n\n💊 Prescriptions (${patient.prescriptions.length}):\n${patient.prescriptions.map((p, i) => `${i + 1}. ${p.number}`).join('\n')}\n\n${patient.generalNote ? `📝 Note: ${patient.generalNote}\n\n` : ''}Please check the downloaded image for QR codes! 📲`;
        
        const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        
        // Clean up
        setTimeout(() => {
            URL.revokeObjectURL(url);
        }, 1000);
    }, 500);
}

        function fallbackWhatsAppShare(blob, patient) {
            const url = URL.createObjectURL(blob);
            const message = `*Patient Card*\n\n📋 ID: ${patient.nationalId}\n📅 Next Refill: ${patient.nextRefillDate}\n💊 Prescriptions: ${patient.prescriptions.map(p => p.number).join(', ')}`;
            
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = url;
                link.download = `patient-${patient.nationalId}.png`;
                link.click();
                URL.revokeObjectURL(url);
            }, 1000);
        }
        
     // ============================================
// EXPORT FUNCTIONS (Fixed Data Types)
// ============================================

function exportData(format) {
    if (patients.length === 0) {
        showModal(
            '<span style="color: var(--warning);">⚠️ Warning</span>',
            '<p style="text-align: center; padding: 20px;">No data to export!</p>',
            '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
        );
        return;
    }
    
    switch(format) {
        case 'json':
            exportJSON();
            break;
        case 'excel':
            exportExcel();
            break;
        case 'text':
            exportText();
            break;
    }
}

function exportJSON() {
    // هيكلة البيانات لتكون واضحة عند الاستيراد
    let data = {
        meta: {
            exportDate: new Date().toISOString(),
            pharmacy: currentUser.pharmacy_code,
            totalPatients: patients.length,
            version: "2.0"
        },
        data: patients // البيانات الأساسية
    };
    
    let blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = `mono-patients-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function exportExcel() {
    let rows = [];
    
    patients.forEach(patient => {
        patient.prescriptions.forEach((presc, idx) => {
            rows.push({
                // إضافة مسافة فارغة أو علامة اقتباس لإجبار الإكسل على قراءتها كنص
                'ID': String(patient.nationalId), 
                'Phone': String(patient.phoneNumber || ''),
                'Dispensing Date': patient.dispensingDate,
                'Next Refill Date': patient.nextRefillDate,
                'Refill Period': patient.refillPeriod,
                'Prescription Number': String(presc.number), // هام جداً للوصفات
                'Prescription Note': presc.note,
                'General Note': idx === 0 ? patient.generalNote : '', // الملاحظة تظهر مرة واحدة
                'Status': getRefillStatus(patient.nextRefillDate) || 'scheduled'
            });
        });
    });
    
    // إنشاء الشيت
    let ws = XLSX.utils.json_to_sheet(rows);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Patients');
    
    // تصدير الملف
    XLSX.writeFile(wb, `mono-patients-${new Date().toISOString().split('T')[0]}.xlsx`);
}

function exportText() {
    let text = `MONO Mono Wasfaty SYSTEM\n`;
    text += `Export Date: ${new Date().toLocaleString()}\n`;
    text += `Total Records: ${patients.length}\n`;
    text += `================================================================\n\n`;
    
    patients.forEach((patient, idx) => {
        text += `[${idx + 1}] Patient ID: ${patient.nationalId}\n`;
        if(patient.phoneNumber) text += `    Phone: ${patient.phoneNumber}\n`;
        text += `    Dispensing: ${patient.dispensingDate} | Next Refill: ${patient.nextRefillDate}\n`;
        text += `    Prescriptions:\n`;
        patient.prescriptions.forEach((presc, i) => {
            text += `      - ${presc.number} ${presc.note ? '('+presc.note+')' : ''}\n`;
        });
        if (patient.generalNote) text += `    Note: ${patient.generalNote}\n`;
        text += `----------------------------------------------------------------\n`;
    });
    
    let blob = new Blob([text], { type: 'text/plain' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = `mono-patients-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}
        function parseTextData(text) {
            let records = [];
            let lines = text.split('\n');
            let currentRecord = null;
            
            lines.forEach(line => {
                line = line.trim();
                
                if (line.includes('ID:') || line.includes('National ID:')) {
                    if (currentRecord && currentRecord.nationalId) {
                        records.push(currentRecord);
                    }
                    currentRecord = {
                        nationalId: line.split(':')[1].trim(),
                        phoneNumber: '',
                        dispensingDate: new Date().toISOString().split('T')[0],
                        refillPeriod: 24,
                        nextRefillDate: '',
                        prescriptions: [],
                        generalNote: '',
                        imported: true
                    };
                } else if (currentRecord) {
                    if (line.includes('Phone:')) {
                        currentRecord.phoneNumber = line.split(':')[1].trim();
                    } else if (line.includes('Dispensing:')) {
                        currentRecord.dispensingDate = line.split(':')[1].trim();
                    } else if (line.includes('Refill:')) {
                        currentRecord.nextRefillDate = line.split(':')[1].trim();
                    } else if (line.match(/[a-z][0-9]{7}/)) {
                        let prescNum = line.match(/[a-z][0-9]{7}/)[0];
                        currentRecord.prescriptions.push({
                            number: prescNum,
                            note: ''
                        });
                    }
                }
            });
            
            if (currentRecord && currentRecord.nationalId) {
                records.push(currentRecord);
            }
            
            return records;
        }
        
        /* ==========================================
   SMART IMPORT SYSTEM (Dr. Mo Edition)
   ========================================== */
/* ==========================================
   DR. MO SMART IMPORT SYSTEM (TRIAGE EDITION)
   ========================================== */

// دالة مساعدة لتحليل سبب الفشل وعرض المودال المناسب
function analyzeImportFailure(skipped) {
    if (skipped.length === 0) {
        showModal(
            '<span style="color: var(--warning);">⚠️ Empty File</span>',
            '<p style="text-align: center; padding: 20px;">No readable data found in the file.</p>',
            '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
        );
        return;
    }

    const duplicates = skipped.filter(s => s.type === 'duplicate');
    const errors = skipped.filter(s => s.type === 'error');

    // الحالة 1: الملف كله مكرر (Duplicates)
    if (duplicates.length > 0 && errors.length === 0) {
        showModal(
            '<span style="color: var(--info);">⚠️ Duplicates Detected</span>',
            `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 40px; margin-bottom: 10px;">🔁</div>
                <h3 style="color: var(--dark);">All Records Already Exist</h3>
                <p style="color: #636E72; font-size: 14px; margin-top: 10px;">
                    This file contains <b>${duplicates.length}</b> records that are already in your system.
                </p>
                <div style="background: #F8F9FE; padding: 10px; border-radius: 8px; margin-top: 15px; max-height: 150px; overflow-y: auto; text-align: left; font-size: 11px; font-family: monospace;">
                    ${duplicates.map(d => `<div style="color: #0984e3;">• ${d.msg.replace('Row ', 'Row ')}</div>`).join('')}
                </div>
            </div>
            `,
            '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">Close</button>'
        );
    }
    // الحالة 2: الملف كله أخطاء تنسيق (Errors)
    else if (errors.length > 0 && duplicates.length === 0) {
        showModal(
            '<span style="color: var(--danger);">❌ Format Errors</span>',
            `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 40px; margin-bottom: 10px;">🚫</div>
                <h3 style="color: var(--dark);">Invalid Data Format</h3>
                <p style="color: #636E72; font-size: 14px; margin-top: 10px;">
                    Found <b>${errors.length}</b> records with incorrect formats.<br>
                    <span style="font-size: 12px; color: var(--danger);">Remember: ID must be 10 digits (starts 1-4), Rx starts with letter.</span>
                </p>
                <div style="background: #FFF5F5; padding: 10px; border-radius: 8px; margin-top: 15px; max-height: 150px; overflow-y: auto; text-align: left; font-size: 11px; font-family: monospace; border: 1px solid #FEB2B2;">
                    ${errors.map(e => `<div style="color: #C53030;">• ${e.msg}</div>`).join('')}
                </div>
            </div>
            `,
            '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">Check File</button>'
        );
    }
    // الحالة 3: خليط (Mixed)
    else {
        showModal(
            '<span style="color: var(--warning);">⚠️ Import Failed</span>',
            `
            <div style="text-align: center; padding: 20px;">
                <p style="margin-bottom: 10px;">No valid records to import.</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                    <span style="background: #F8F9FE; color: #0984e3; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold;">${duplicates.length} Duplicates</span>
                    <span style="background: #FFF5F5; color: #C53030; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold;">${errors.length} Errors</span>
                </div>
                <div style="background: #F1F2F6; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; text-align: left; font-size: 11px; font-family: monospace;">
                    ${skipped.map(s => `<div style="color: ${s.type === 'error' ? '#C53030' : '#0984e3'};">• ${s.msg}</div>`).join('')}
                </div>
            </div>
            `,
            '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">Close</button>'
        );
    }
}

function processAndValidateData(rawData, isTextFile) {
    let validPatients = {}; // لتجميع البيانات الجديدة
    let updatesToCheck = []; // لتخزين التحديثات
    let skipped = []; // لتخزين ما تم تخطيه مع السبب
    
    // 🔥 1. تحديد وقت موحد للملف بالكامل (عشان ميزة تجميع الواردات في بوكس واحد)
    const batchTimestamp = new Date().toISOString(); 

    const patterns = {
        id: /^[1-4]\d{9}$/,
        rx: /^[a-zA-Z]\d{7}$/,
        phoneExtraction: /(?:966|0)?(5\d{8})/
    };

    const cleanString = (val) => String(val || '').trim();

    rawData.forEach((row, index) => {
        let raw = {};
        
        // --- Mapping (ربط الأعمدة) ---
        if (isTextFile || row.nationalId) {
            raw = { id: cleanString(row.nationalId), rx: cleanString(row.prescription), phone: cleanString(row.phoneNumber), date: cleanString(row.dispensingDate), nextRefill: cleanString(row.nextRefillDate), rxNote: '', genNote: cleanString(row.note) };
        } else {
            const keys = Object.keys(row);
            const getKey = (substr) => keys.find(k => k.toLowerCase().includes(substr.toLowerCase()));
            raw.id = cleanString(row[getKey('ID')] || row['ID'] || row['National ID']);
            raw.rx = cleanString(row[getKey('Prescription')] || row['Rx']);
            raw.phone = cleanString(row[getKey('Phone')] || row['Mobile']);
            raw.date = cleanString(row[getKey('Dispensing')] || row['Date']);
            raw.nextRefill = cleanString(row[getKey('Next')] || row['Refill']);
            raw.genNote = cleanString(row[getKey('Note')]);
        }

        const cleanId = raw.id.replace(/\D/g, '');
        const cleanRx = raw.rx.replace(/\s/g, '').toLowerCase();
        
        // استخراج الجوال بصيغة سعودية صحيحة
        let extractedPhone = '';
        const phoneMatch = raw.phone.replace(/\D/g, '').match(patterns.phoneExtraction);
        if (phoneMatch) extractedPhone = '0' + phoneMatch[1];

        // --- 1. فحص صحة البيانات (Validation) ---
        if (!patterns.id.test(cleanId)) {
            skipped.push({ 
                row: index + 1, 
                id: raw.id, 
                reason: "❌ Invalid ID Format (صيغة الهوية خطأ)" 
            });
            return;
        }

        // --- 2. البحث في قاعدة البيانات (Match Logic) ---
        // هل هذا الكارت (هوية + وصفة) موجود مسبقاً؟
        const existingExactMatch = patients.find(p => 
            p.nationalId === cleanId && 
            p.prescriptions.some(pr => pr.number === cleanRx)
        );

        if (existingExactMatch) {
            // === حالة موجود مسبقاً (Check for Updates) ===
            let changes = [];
            
            // أ) فحص الجوال
            if (extractedPhone && existingExactMatch.phoneNumber !== extractedPhone) {
                changes.push(`Phone: ${existingExactMatch.phoneNumber || 'None'} ➝ ${extractedPhone}`);
            }
            
            // ب) فحص تاريخ الريفيل
            if (raw.nextRefill) {
                const newDate = new Date(raw.nextRefill).toISOString().split('T')[0];
                if (existingExactMatch.nextRefillDate !== newDate) {
                    changes.push(`Date: ${existingExactMatch.nextRefillDate} ➝ ${newDate}`);
                }
            }

            // ج) فحص الملاحظات
            if (raw.genNote && (!existingExactMatch.generalNote || !existingExactMatch.generalNote.includes(raw.genNote))) {
                changes.push(`Note Added: ${raw.genNote}`);
            }

            if (changes.length > 0) {
                // نمنع التكرار داخل القائمة لنفس المريض
                const alreadyQueued = updatesToCheck.find(u => u.dbId === existingExactMatch.id);
                if (!alreadyQueued) {
                    updatesToCheck.push({
                        dbId: existingExactMatch.id,
                        nationalId: cleanId,
                        changes: changes, // قائمة التغييرات للعرض في البريفيو
                        newPhone: extractedPhone || existingExactMatch.phoneNumber,
                        newDate: raw.nextRefill ? new Date(raw.nextRefill).toISOString().split('T')[0] : existingExactMatch.nextRefillDate,
                        newNote: raw.genNote ? (existingExactMatch.generalNote + ", " + raw.genNote) : existingExactMatch.generalNote
                    });
                }
            } else {
                // لا يوجد أي تغيير
                skipped.push({ 
                    row: index + 1, 
                    id: cleanId, 
                    reason: "⚠️ Exact Duplicate - No Changes (مكرر بدون أي تغيير)" 
                });
            }
            return; 
        }

        // === حالة جديد (New Card) ===
        
        // تحديد النوع: هل الهوية موجودة مسبقاً (مع وصفة أخرى) أم جديدة كلياً؟
        const isIdentityExists = patients.some(p => p.nationalId === cleanId);
        const typeLabel = isIdentityExists ? "وصفة جديدة (هوية موجودة)" : "هوية جديدة بالكامل";
        
        // حساب التواريخ
        let importDispensingDate = (raw.date && !isNaN(new Date(raw.date))) ? new Date(raw.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
        let importNextRefillDate = (raw.nextRefill && !isNaN(new Date(raw.nextRefill))) ? new Date(raw.nextRefill).toISOString().split('T')[0] : "";
        
        if (!importNextRefillDate) {
            let d = new Date(importDispensingDate);
            d.setDate(d.getDate() + 24);
            importNextRefillDate = d.toISOString().split('T')[0];
        }

        const uniqueKey = `${cleanId}`; 
        
        if (!validPatients[uniqueKey]) {
            validPatients[uniqueKey] = {
                nationalId: cleanId,
                phoneNumber: extractedPhone,
                dispensingDate: importDispensingDate,
                refillPeriod: 24,
                nextRefillDate: importNextRefillDate,
                prescriptions: [],
                generalNote: raw.genNote,
                imported: true,
                
                // 🔥 معلومات إضافية مهمة للفلترة والعرض
                importType: typeLabel, 
                importDate: batchTimestamp 
            };
        }

        if (cleanRx && !validPatients[uniqueKey].prescriptions.find(p => p.number === cleanRx)) {
            validPatients[uniqueKey].prescriptions.push({
                number: cleanRx,
                note: raw.rxNote
            });
        }
    });

    return {
        valid: Object.values(validPatients),
        updates: updatesToCheck,
        skipped: skipped
    };
}
function showImportPreviewUI(result) {
    // 1. الانتقال لتاب الداتا وتجهيز الحاوية
    switchTab('data');
    const container = document.getElementById('importPreview');
    
    // وعاء HTML الرئيسي مع أنيميشن بسيط
    let html = `<div style="background: white; padding: 20px; border-radius: 16px; border: 2px solid var(--primary); margin-top: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); animation: slideUp 0.3s ease;">`;

    // ============================================================
    // 1. قسم التحديثات (Updates) - اللون الأزرق
    // ============================================================
    if (result.updates && result.updates.length > 0) {
        html += `
            <div style="background: #E3F2FD; border: 1px solid #90CAF9; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: #1565C0; margin-top: 0; display: flex; align-items: center; gap: 10px; font-size: 16px;">
                    <span>🔄</span> Found ${result.updates.length} Updates (بيانات معدلة)
                </h3>
                <div style="max-height: 200px; overflow-y: auto; background: white; border: 1px solid #BBDEFB; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead style="background: #f1f8ff; position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">ID</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Changes Detected</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.updates.map(u => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px; font-family: monospace; font-weight:bold; color: #1565C0;">${u.nationalId}</td>
                                    <td style="padding: 8px;">
                                        ${u.changes.map(c => `<div style="background:#E1F5FE; color:#0277BD; padding:2px 8px; border-radius:4px; display:inline-block; margin-right: 4px; margin-bottom:2px; font-size:11px; border: 1px solid #B3E5FC;">${c}</div>`).join('')}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // ============================================================
    // 2. قسم الجديد (New Cards) - اللون الأخضر
    // ============================================================
    if (result.valid.length > 0) {
        html += `
            <div style="background: #E8F5E9; border: 1px solid #A5D6A7; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: #2E7D32; margin-top: 0; display: flex; align-items: center; gap: 10px; font-size: 16px;">
                    <span>➕</span> Found ${result.valid.length} New Cards (كروت جديدة)
                </h3>
                <div style="max-height: 200px; overflow-y: auto; background: white; border: 1px solid #C8E6C9; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead style="background: #f9fdf9; position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Type</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">ID</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Prescriptions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.valid.map((p, i) => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">
                                        <span style="font-weight:bold; font-size:10px; padding:3px 8px; border-radius:10px; 
                                            background: ${p.importType.includes('هوية جديدة') ? '#2ecc71' : '#f1c40f'}; 
                                            color: ${p.importType.includes('هوية جديدة') ? 'white' : 'black'}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                            ${p.importType}
                                        </span>
                                    </td>
                                    <td style="padding: 8px; font-family: monospace; font-weight: bold; color: #2D3436;">${p.nationalId}</td>
                                    
                                    <td style="padding: 8px;">
                                        ${p.prescriptions.map(rx => 
                                            `<span style="display:inline-block; background:#fff; border:1px solid #bdc3c7; padding:2px 6px; border-radius:4px; margin-right:4px; font-family:monospace; color:#2d3436; font-size: 11px; font-weight: 600;">
                                                ${rx.number}
                                            </span>`
                                        ).join('')}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // ============================================================
    // 3. قسم التخطي (Skipped) - القائمة المنسدلة
    // ============================================================
    if (result.skipped.length > 0) {
        html += `
            <div style="border-top: 2px dashed #ddd; margin-top: 15px; padding-top: 15px;">
                <details>
                    <summary style="cursor: pointer; color: #636E72; font-size: 13px; font-weight: 700; outline: none; user-select: none;">
                        ⚠️ Skipped ${result.skipped.length} Records (Click to View Details)
                    </summary>
                    <div style="margin-top: 10px; max-height: 150px; overflow-y: auto; background: #F8F9FE; border-radius: 8px; padding: 10px; border: 1px solid #eee;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            ${result.skipped.map(s => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 5px; color: #999; width: 60px;">Row ${s.row}</td>
                                    <td style="padding: 5px; font-family: monospace; font-weight: bold; width: 100px;">${s.id || 'N/A'}</td>
                                    <td style="padding: 5px; color: ${s.reason.includes('❌') ? '#c0392b' : '#e67e22'}; font-weight: 600;">${s.reason}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                </details>
            </div>
        `;
    }

    // ============================================================
    // 4. أزرار التحكم (Execute / Cancel)
    // ============================================================
    const totalOps = result.valid.length + (result.updates ? result.updates.length : 0);
    
    if (totalOps > 0) {
        html += `
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-top: 20px;">
                <button class="btn-primary" onclick="confirmSmartImport()" style="height: 50px; font-size: 14px; letter-spacing: 1px;">
                    EXECUTE (${totalOps} OPERATIONS)
                </button>
                <button class="btn-secondary" onclick="cancelImport()" style="height: 50px;">
                    CANCEL
                </button>
            </div>
        `;
    } else {
        html += `
            <div style="text-align:center; padding:20px;">
                <div style="font-size: 30px; margin-bottom: 10px;">🤷‍♂️</div>
                <p style="color: #666; font-weight: 600;">No actionable data found in this file.</p>
                <button class="btn-secondary" onclick="cancelImport()" style="margin-top: 10px;">Close</button>
            </div>
        `;
    }

    html += `</div>`;
    container.innerHTML = html;
}
// ============================================
// 3. EXECUTE IMPORT (Updates + Inserts)
// ============================================
async function confirmSmartImport() {
    const container = document.getElementById('importPreview');
    container.innerHTML = `
        <div style="text-align:center; padding:40px;">
            <div class="loading" style="width:40px; height:40px; border-width:4px; border-color: var(--primary) transparent var(--primary) transparent;"></div>
            <h3 style="margin-top:20px; color: var(--primary);">Processing Data...</h3>
            <p style="color: #666;">Updating Phones & Adding Patients</p>
        </div>
    `;

    let updateCount = 0;
    let addCount = 0;

    try {
        // 1. تنفيذ التحديثات (Updates)
        if (pendingUpdates && pendingUpdates.length > 0) {
            for (const update of pendingUpdates) {
                const { error } = await supabaseClient
                    .from('patients')
                    .update({ phone_number: update.newPhone })
                    .eq('id', update.dbId);
                
                if (!error) updateCount++;
            }
        }

        // 2. تنفيذ الإضافات الجديدة (New Records)
        if (pendingImportData && pendingImportData.length > 0) {
            // نستخدم دالة الحفظ الموجودة
            // للسرعة، يمكن استخدام Promise.all لكن التسلسل أكثر أماناً لتجنب الضغط
            for (const patient of pendingImportData) {
                await savePatientToSupabase(patient);
                addCount++;
            }
        }

        // 3. الانتهاء وإعادة التحميل
        await loadPatientsFromSupabase();
        
        showModal(
            '<span style="color: var(--secondary);">✅ Operation Complete</span>',
            `
            <div style="text-align: center; padding: 20px;">
                <div style="width: 60px; height: 60px; background: #E8F5E9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <span style="font-size: 30px;">🎉</span>
                </div>
                <p style="font-size: 16px; margin-bottom: 20px; font-weight: bold; color: var(--dark);">Data processed successfully!</p>
                
                <div style="background: #F8F9FE; padding: 15px; border-radius: 12px; text-align: left;">
                    <div style="margin-bottom: 8px; font-size: 14px; display: flex; justify-content: space-between;">
                        <span style="color: #1565C0;">📲 Phones Updated:</span>
                        <b>${updateCount}</b>
                    </div>
                    <div style="font-size: 14px; display: flex; justify-content: space-between;">
                        <span style="color: #2E7D32;">➕ Patients Added:</span>
                        <b>${addCount}</b>
                    </div>
                </div>
            </div>
            `,
            '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal(); switchTab(\'patients\'); displayPatients()">View All Patients</button>'
        );

        // تنظيف المتغيرات والواجهة
        document.getElementById('importPreview').innerHTML = '';
        pendingImportData = null;
        pendingUpdates = null;

    } catch (error) {
        console.error('Import Error:', error);
        showModal('<span style="color:red">Error</span>', `<p>${error.message}</p>`, '<button class="btn-primary" onclick="closeModal()">OK</button>');
    }
}
function handleImportFile(e) {
    let file = e.target.files[0];
    if (!file) return;

    // 1. 🔥 عرض شاشة التحميل فوراً
    const container = document.getElementById('importPreview');
    container.innerHTML = `
        <div style="text-align:center; padding:50px;">
            <div class="loading" style="width:50px; height:50px; border-width:5px; border-color: var(--primary) transparent var(--primary) transparent; display:inline-block;"></div>
            <h3 style="margin-top:20px; color: var(--primary);">Reading File...</h3>
            <p style="color: #666; font-size:13px;">Analyzing records, please wait...</p>
        </div>
    `;
    
    // التأكد من أننا في تبويب Data
    switchTab('data'); 

    // إعطاء فرصة للمتصفح لرسم اللودينج قبل التجميد في العمليات الحسابية
    setTimeout(() => {
        let reader = new FileReader();
        reader.onload = function(event) {
            try {
                let rawData = [];
                // قراءة الملف حسب نوعه
                if (file.name.toLowerCase().endsWith('.json')) {
                    let jsonContent = JSON.parse(event.target.result);
                    rawData = Array.isArray(jsonContent) ? jsonContent : (jsonContent.data || []);
                } else if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                    let workbook = XLSX.read(event.target.result, { type: 'binary' });
                    rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
                } else if (file.name.toLowerCase().endsWith('.txt')) {
                    rawData = parseSmartTextData(event.target.result);
                }

                // المعالجة الذكية
                const result = processAndValidateData(rawData, file.name.toLowerCase().endsWith('.txt'));
                
                // تخزين النتائج
                pendingImportData = result.valid;
                pendingUpdates = result.updates;
                
                // عرض النتيجة النهائية (سيختفي اللودينج هنا)
                showImportPreviewUI(result);

            } catch (error) {
                console.error(error);
                showModal('Error', 'Invalid or Corrupted File', 'OK');
                container.innerHTML = ''; // إخفاء اللودينج عند الخطأ
            }
        };

        if (file.name.match(/xls|xlsx/)) reader.readAsBinaryString(file);
        else reader.readAsText(file);
        
    }, 100); // تأخير بسيط جداً (100ms) لضمان ظهور اللودينج
    
    e.target.value = ''; 
}
// 6. Helpers (Standard Protocol)
function cancelImport() {
    pendingImportData = null;
    skippedRecords = [];
    document.getElementById('importPreview').innerHTML = '';
    showModal(
        '<span style="color: var(--info);">ℹ️ Cancelled</span>',
        '<p style="text-align: center; padding: 20px;">Import operation cancelled.</p>',
        '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
    );
}

function createBackup() {
    exportJSON();
}

async function restoreBackup() {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async function(e) {
        let file = e.target.files[0];
        if (!file) return;
        
        let reader = new FileReader();
        reader.onload = async function(event) {
            try {
                let backup = JSON.parse(event.target.result);
                // Handle different backup structures
                let data = Array.isArray(backup) ? backup : (backup.data || []);

                if (data.length > 0) {
                    // Use standard confirmation, then reuse the optimized save loop if possible
                    // Or keep simple loop for backups as they are rarely massive
                    confirmAction(`Restore ${data.length} patient(s) from backup?`, async function() {
                        // Reuse the batch logic here too for speed? 
                        // Let's keep it simple for restore but reliable
                        let success = 0;
                        try {
                             // Using Batch Logic for Restore too (Faster)
                            const BATCH_SIZE = 50;
                            for (let i = 0; i < data.length; i += BATCH_SIZE) {
                                const chunk = data.slice(i, i + BATCH_SIZE);
                                await Promise.all(chunk.map(p => savePatientToSupabase(p)));
                                success += chunk.length;
                            }

                            await loadPatientsFromSupabase();
                            displayPatients();
                            
                            showModal(
                                '<span style="color: var(--secondary);">✅ Success</span>',
                                '<p style="text-align: center; padding: 20px;">Backup restored successfully!</p>',
                                '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                            );
                        } catch (error) {
                            showModal(
                                '<span style="color: var(--danger);">❌ Error</span>',
                                `<p style="text-align: center; padding: 20px;">Error restoring backup: ${error.message}</p>`,
                                '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                            );
                        }
                    });
                } else {
                    throw new Error("Empty or invalid backup file");
                }
            } catch (error) {
                console.error(error);
                showModal(
                    '<span style="color: var(--danger);">❌ Error</span>',
                    `<p style="text-align: center; padding: 20px;">Error reading backup: ${error.message}</p>`,
                    '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
                );
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

function deleteAll() {
    confirmAction(`⚠️ WARNING: This will delete ALL ${patients.length} patient(s)! This action cannot be undone!`, async function() {
        try {
            const { error } = await supabaseClient
                .from('patients')
                .delete()
                .eq('pharmacy_id', currentUser.id);
            
            if (error) throw error;
            
            await loadPatientsFromSupabase();
            displayPatients();
            
            showModal(
                '<span style="color: var(--secondary);">✅ Success</span>',
                '<p style="text-align: center; padding: 20px;">All data deleted successfully!</p>',
                '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
            );
        } catch (error) {
            showModal(
                '<span style="color: var(--danger);">❌ Error</span>',
                `<p style="text-align: center; padding: 20px;">Error: ${error.message}</p>`,
                '<button class="btn-primary" style="grid-column: 1/3;" onclick="closeModal()">OK</button>'
            );
        }
    });
}

// Close modal when clicking outside
document.getElementById('modalOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

function addQuickNote(text) {
    const noteArea = document.getElementById('generalNote');
    // إذا كان هناك نص بالفعل، أضف فاصلة، وإلا أضف النص مباشرة
    if (noteArea.value.trim().length > 0) {
        // نتأكد أننا لا نكرر نفس الملاحظة
        if (!noteArea.value.includes(text)) {
            noteArea.value += ', ' + text;
        }
    } else {
        noteArea.value = text;
    }
}
// ============================================
// ⚡ FAST COPY UTILITIES (NO LAG)
// ============================================

// دالة عرض التنبيه السريع (بديل المودال)
function showToast(message) {
    const toast = document.getElementById('toastNotification');
    const textEl = document.getElementById('toastText');
    
    if (toast && textEl) {
        textEl.textContent = message;
        toast.classList.add('show');
        
        // إخفاء تلقائي بعد 2 ثانية
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
    }
}

// دالة النسخ الهجين (الأكثر سرعة واستقراراً)
function fastCopyText(text) {
    // محاولة استخدام الطريقة القديمة (Synchronous) لأنها أسرع في الاستجابة اللحظية
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // إخفاء العنصر تماماً عشان ميبوظش الشكل
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    textArea.style.opacity = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    let successful = false;
    try {
        successful = document.execCommand('copy');
    } catch (err) {
        console.warn('Fallback copy failed, trying Async API', err);
    }
    document.body.removeChild(textArea);

    // لو الطريقة القديمة فشلت، نجرب الحديثة (Async)
    if (!successful && navigator.clipboard) {
        navigator.clipboard.writeText(text).catch(err => {
            console.error('Async copy failed', err);
            showModal('Error', 'Failed to copy text', 'OK');
        });
    }
}

// ============================================
// ⚡ UPDATED BUTTON FUNCTIONS
// ============================================

function copyRxOnly(nationalId, prescriptionNumber) {
    const textToCopy = `${nationalId} ${prescriptionNumber}`;
    
    // 1. تنفيذ النسخ فوراً (بدون انتظار Promise)
    fastCopyText(textToCopy);
    
    // 2. عرض رسالة خفيفة (Toast) بدلاً من المودال الكبير
    showToast(`تم النسخ: ${prescriptionNumber}`);
}

function checkPrescription(nationalId, prescriptionNumber) {
    const combinedData = `${nationalId} ${prescriptionNumber}`;
    
    // 1. نسخ فوري
    fastCopyText(combinedData);
    
    // 2. عرض تنبيه سريع
    showToast('تم النسخ وفتح وصفتي 🚀');
    
    // 3. فتح الموقع (بتأخير بسيط جداً لضمان ان المتصفح استوعب النسخ)
    setTimeout(() => {
        window.open('https://ul.wasfaty.sa/support', '_blank');
    }, 100);
}
// تعريف متغير عالمي لتخزين العدد الحقيقي
let totalRealCount = 0;

async function loadPatientsFromSupabase() {
    try {
        console.log('🔄 Loading patients from Database...');
        
        // 1. جلب البيانات (أول 10000 صف)
        const { data: patientsData, error, count } = await supabaseClient
            .from('patients')
            .select(`
                *,
                prescriptions (*)
            `, { count: 'exact' }) 
            .eq('pharmacy_id', currentUser.id)
            .order('created_at', { ascending: false }) // الأحدث يظهر أولاً
            .range(0, 9999); 
        
        if (error) throw error;
        
        totalRealCount = count;
        
        // 2. تحويل البيانات (Mapping) مع ضمان تحويل الهوية لنص
        patients = patientsData.map(p => ({
            id: p.id,
            nationalId: String(p.national_id || ''), // 🔥 تحويل لنص لضمان البحث
            phoneNumber: String(p.phone_number || ''),
            dispensingDate: p.dispensing_date,
            refillPeriod: p.refill_period,
            nextRefillDate: p.next_refill_date,
            generalNote: p.general_note,
            imported: p.imported,
            importDate: p.import_date, 
            inQueue: p.in_queue,
            cardColor: p.cardcolor || 'none',
            createdAt: p.created_at,
            updatedAt: p.updated_at,
            prescriptions: p.prescriptions.map(pr => ({
                number: String(pr.prescription_number || ''),
                note: pr.note
            }))
        }));
        
        // 3. ملء طابور الصرف
        dispensingQueue = patients.filter(p => p.inQueue === true);
        dispensingQueue.sort((a, b) => new Date(a.updatedAt) - new Date(b.updatedAt));
        dispensingQueue.forEach((p, index) => p.queueNumber = index + 1);
        
        console.log(`✅ Loaded ${patients.length} rows.`);
        
        // 4. تحديث الإحصائيات
        updateStats(); 

        // 5. 🔥 إعداد محرك البحث (Fuse.js) بإعدادات مرنة 🔥
        if (window.Fuse) {
            fuse = new Fuse(patients, {
                keys: [
                    'nationalId', 
                    'phoneNumber', 
                    'generalNote',
                    'prescriptions.number', 
                    'prescriptions.note'
                ],
                threshold: 0.3, // ⚠️ خليناها 0.3 عشان يقبل بحث جزئي
                distance: 100,
                minMatchCharLength: 2, // يبدأ بحث من حرفين
                ignoreLocation: true,
                useExtendedSearch: true
            });
            console.log('🔍 Fuse Engine Configured (Flexible Mode)');
        }

    } catch (error) {
        console.error('❌ Error loading patients:', error);
        showModal('Error', `Failed to load data: ${error.message}`, '<button class="btn-primary" onclick="closeModal()">OK</button>');
    }
}
// ============================================
// DISPENSED TAB LOGIC (PERSISTENT QUEUE)
// ============================================

let dispensingQueue = []; 

// 1. البحث (لم يتغير)
function searchForDispensing() {
    const input = document.getElementById('dispenseSearchInput');
    const dropdown = document.getElementById('dispenseSearchResults');
    const term = input.value.trim();

    if (term.length < 2) {
        dropdown.style.display = 'none';
        return;
    }

    let results = [];
    if (fuse) {
        results = fuse.search(term).slice(0, 5).map(r => r.item);
    } else {
        results = patients.filter(p => 
            p.nationalId.includes(term) || 
            (p.phoneNumber && p.phoneNumber.includes(term))
        ).slice(0, 5);
    }

    if (results.length === 0) {
        dropdown.style.display = 'none';
        return;
    }

    dropdown.innerHTML = results.map(p => `
        <div class="dispense-result-item" onclick="addToQueue('${String(p.id)}')">
            <div>
                <div style="font-weight:800; color:var(--primary); font-family: 'Courier New', monospace;">${p.nationalId}</div>
                <div style="font-size:11px; color:#666;">${p.phoneNumber || 'No Phone'}</div>
            </div>
            <div style="background:var(--light); padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold; color:var(--primary);">
                Add +
            </div>
        </div>
    `).join('');

    dropdown.style.display = 'block';
}
async function addToQueue(patientId) {
    const pId = String(patientId);
    const patient = patients.find(p => String(p.id) === pId);
    if (!patient) return;
    
    if (dispensingQueue.find(p => String(p.id) === pId)) {
        document.getElementById('dispenseSearchInput').value = '';
        document.getElementById('dispenseSearchResults').style.display = 'none';
        return;
    }
    
    const maxNumber = dispensingQueue.reduce((max, p) => 
        p.queueNumber > max ? p.queueNumber : max, 0
    );
    
    patient.queueNumber = maxNumber + 1;
    patient.inQueue = true;
    patient.cardColor = 'none'; // ✅ إضافة اللون الافتراضي
    
    dispensingQueue.push(patient);
    filterQueue();
    
    document.getElementById('dispenseSearchInput').value = '';
    document.getElementById('dispenseSearchResults').style.display = 'none';
    
    try {
        await supabaseClient
            .from('patients')
            .update({ inqueue: true })
            .eq('id', pId);
    } catch(err) {
        console.error('Failed to add to queue (DB):', err);
    }
}

// 3. فلترة الجدول
function filterQueue() {
    const input = document.getElementById('queueFilterInput');
    const filterText = input ? input.value.toLowerCase().trim() : '';
    renderDispensingQueue(filterText);
}
function renderDispensingQueue(filterText) {
    const tbody = document.getElementById('dispensingQueueBody');
    const emptyMsg = document.getElementById('emptyDispenseMsg');
    const countBadge = document.getElementById('queueCount');
    
    const displayList = dispensingQueue.filter(p => {
        if (!filterText) return true;
        return (
            p.nationalId.includes(filterText) ||
            (p.phoneNumber && p.phoneNumber.includes(filterText)) ||
            p.prescriptions.some(rx => rx.number.toLowerCase().includes(filterText))
        );
    });
    
    if (countBadge) {
        countBadge.textContent = dispensingQueue.length;
    }
    
    if (displayList.length === 0) {
        tbody.innerHTML = '';
        if (dispensingQueue.length === 0) {
            emptyMsg.style.display = 'block';
        } else {
            emptyMsg.style.display = 'none';
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:#aaa">No matches found</td></tr>`;
        }
        return;
    }
    
    emptyMsg.style.display = 'none';
    
    tbody.innerHTML = displayList.map((p, index) => `
        <tr id="queue-row-${p.id}" 
            class="${p.cardColor === 'blue' ? 'color-blue' : ''}" 
            style="transition: background 0.3s; position: relative;">
            <td style="text-align: center;">
                <button class="btn-remove-queue" 
                        onclick="confirmRemoveFromQueue('${p.id}')" 
                        title="Remove" 
                        style="background: #FFEBEE; border:none; width:24px; height:24px; border-radius:6px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#D32F2F" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </td>
            <td>
                <span style="font-weight:bold; color:#aaa;">${p.queueNumber || (index + 1)}</span>
            </td>
            <td>
                <div style="font-weight:800; font-family:'Courier New', monospace; color:var(--dark); font-size:16px;">
                    ${p.nationalId}
                </div>
            </td>
            <td>
                <div class="rx-chips-mini">
                    ${p.prescriptions.map(rx => `<span class="rx-chip-mini">${rx.number}</span>`).join('')}
                </div>
            </td>
            <td style="font-family: 'Courier New', monospace; color: #0984e3; font-weight: 600; font-size: 13px;">
                ${p.phoneNumber ? p.phoneNumber : '<span style="color:#ddd">-</span>'}
            </td>
            <td style="text-align: center; position: relative;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <!-- Toggle Color Button -->
                    <div class="color-indicator ${p.cardColor === 'blue' ? 'active' : ''}" 
                         onclick="toggleCardColor('${p.id}')"
                         title="${p.cardColor === 'blue' ? 'Remove Highlight' : 'Highlight Card'}">
                    </div>
                    
                    <!-- Checkbox للـ Dispense -->
                    <input type="checkbox" 
                           class="dispense-checkbox" 
                           title="Mark as Dispensed" 
                           onclick="handleDispenseCheck(this, '${p.id}')">
                </div>
            </td>
        </tr>
    `).join('');
}

// 5. تأكيد الحذف
function confirmRemoveFromQueue(patientId) {
    showModal(
        '<span style="color: var(--danger);">⚠️ Remove Confirmation</span>',
        `
        <div style="text-align: center; padding: 20px;">
            <p style="font-size: 16px; color: var(--dark); margin-bottom: 10px;">
                Remove this patient from queue?
            </p>
        </div>
        `,
        `
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-action btn-delete" onclick="executeRemoval('${patientId}')" style="justify-content: center; padding: 10px 20px;">
            Yes, Remove
        </button>
        `
    );
}

// 6. تنفيذ الحذف (تحديث السيرفر)
async function executeRemoval(patientId) {
    // تحديث الواجهة
    dispensingQueue = dispensingQueue.filter(p => String(p.id) !== String(patientId));
    filterQueue();
    closeModal();

    // تحديث قاعدة البيانات
    try {
        await supabaseClient
            .from('patients')
            .update({ in_queue: false })
            .eq('id', patientId);
    } catch (err) {
        console.error("Failed to remove from queue DB", err);
    }
}

// 7. زر "تم"
function handleDispenseCheck(checkbox, patientId) {
    if (checkbox.checked) {
        const row = document.getElementById(`queue-row-${patientId}`);
        if(row) row.style.backgroundColor = '#e8f5e9'; 

        setTimeout(() => {
            openRefillDateModal(patientId);
        }, 300);
    }
}

// 8. مودال التاريخ
function openRefillDateModal(patientId) {
    const pId = String(patientId);
    const patient = patients.find(p => String(p.id) === pId);
    if (!patient) return;

    let defaultNextDate = new Date();
    defaultNextDate.setDate(defaultNextDate.getDate() + (parseInt(patient.refillPeriod) || 24));
    let defaultDateStr = defaultNextDate.toISOString().split('T')[0];

    showModal(
        '<span style="color: var(--secondary);">✅ Confirm Dispensing</span>',
        `
        <div style="text-align: center; padding: 15px;">
            <p style="margin-bottom: 15px; color: #2D3436; font-weight:600;">Update Next Refill Date:</p>
            <input type="date" id="modalNewRefillDate" class="form-input" 
                   value="${defaultDateStr}" 
                   style="font-size: 18px; padding: 15px; text-align: center; font-weight: 800; color: var(--primary); border: 2px solid var(--primary);">
        </div>
        `,
        `
        <button class="btn-secondary" onclick="cancelDispense('${pId}')">Cancel</button>
        <button class="btn-primary" onclick="confirmDispenseAndSave('${pId}')">Confirm & Save</button>
        `
    );
}

// 9. إلغاء العملية
function cancelDispense(patientId) {
    const row = document.getElementById(`queue-row-${patientId}`);
    if (row) {
        row.style.backgroundColor = 'white';
        const checkbox = row.querySelector('.dispense-checkbox');
        if (checkbox) checkbox.checked = false;
    }
    closeModal();
}

// 10. الحفظ النهائي (تحديث السيرفر)
async function confirmDispenseAndSave(patientId) {
    const newDate = document.getElementById('modalNewRefillDate').value;
    if (!newDate) return;

    const confirmBtn = document.querySelector('.modal-actions .btn-primary');
    if(confirmBtn) {
        confirmBtn.innerHTML = '<span class="loading"></span> Saving...';
        confirmBtn.disabled = true;
    }

    const pId = String(patientId);
    let patient = patients.find(p => String(p.id) === pId);

    const oldNextRefill = patient.nextRefillDate;
    const oldDispensing = patient.dispensingDate;

    // تحديث البيانات محلياً
    patient.dispensingDate = new Date().toISOString().split('T')[0];
    patient.nextRefillDate = newDate;
    patient.inQueue = false; // خروجه من القائمة

    try {
        // تحديث البيانات في سوبابيز (بما فيها إخراجه من القائمة)
        await supabaseClient
            .from('patients')
            .update({
                dispensing_date: patient.dispensingDate,
                next_refill_date: patient.nextRefillDate,
                in_queue: false // <--- هام: إخراجه من القائمة في الداتابيز
            })
            .eq('id', pId);
        
        // إزالة من القائمة المحلية
        dispensingQueue = dispensingQueue.filter(p => String(p.id) !== pId);
        renderDispensingQueue();
        displayPatients(); 
        closeModal();

    } catch (error) {
        console.error('Save Failed:', error);
        // التراجع عند الخطأ
        patient.nextRefillDate = oldNextRefill;
        patient.dispensingDate = oldDispensing;
        patient.inQueue = true;
        
        closeModal();
        cancelDispense(pId);
        showModal('<span style="color:var(--danger)">❌ Error</span>', '<p>Data not saved.</p>', '<button class="btn-primary" onclick="closeModal()">OK</button>');
    }
}

// إغلاق البحث
document.addEventListener('click', function(e) {
    const container = document.querySelector('.dispense-search-container');
    if (container && !container.contains(e.target)) {
        document.getElementById('dispenseSearchResults').style.display = 'none';
    }
});
// ============================================
// DOCUMENT MANAGER LOGIC (SUPABASE CONNECTED)
// ============================================

// مصفوفة لتخزين الملفات القادمة من قاعدة البيانات
let storedFiles = []; 

// 1. فتح المودال وجلب الملفات من السيرفر
async function openDocsManager() {
    renderDocsModal(); // رسم الهيكل أولاً
    await fetchDocsFromSupabase(); // بدء جلب البيانات
}

// 2. دالة جلب الملفات من قاعدة البيانات (Supabase)
async function fetchDocsFromSupabase() {
    const container = document.getElementById('filesListRender');
    const titleEl = document.getElementById('docsModalTitle');
    
    // عرض حالة التحميل
    if(container) container.innerHTML = '<div style="text-align:center; padding:20px;"><div class="loading" style="border-color:var(--primary) transparent var(--primary) transparent;"></div></div>';

    try {
        // جلب الملفات الخاصة بالصيدلية الحالية فقط
        const { data, error } = await supabaseClient
            .from('pharmacy_docs')
            .select('*')
            .eq('pharmacy_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        storedFiles = data || [];
        renderDocsList(); // إعادة رسم القائمة بالبيانات الحقيقية
        
        // تحديث العنوان بالعدد الصحيح
        if(titleEl) titleEl.textContent = `MY FILES (${storedFiles.length})`;

    } catch (err) {
        console.error('Error fetching docs:', err);
        if(container) container.innerHTML = '<div style="text-align:center; color:#e74c3c; padding:20px;">Failed to load files from cloud ☁️</div>';
    }
}

// 3. دالة رفع الملفات (رفع للسحابة + حفظ في القاعدة)
async function handleDocsUpload(input) {
    if (!input.files || input.files.length === 0) return;

    // حفظ المحتوى الحالي لعرضه في حالة الفشل
    const container = document.getElementById('filesListRender');
    const originalContent = container.innerHTML;
    
    // عرض مؤشر التحميل
    container.innerHTML = `
        <div style="text-align:center; padding:30px;">
            <div class="loading" style="width:30px; height:30px; margin-bottom:10px;"></div>
            <p style="color:var(--primary); font-weight:bold; font-size:12px;">Uploading to Cloud...</p>
        </div>
    `;

    try {
        for (const file of Array.from(input.files)) {
            // A. تجهيز اسم فريد للملف (لمنع التكرار في التخزين)
            // نستخدم Timestamp + تنظيف الاسم من الرموز الغريبة
            const cleanName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
            const filePath = `${currentUser.id}/${Date.now()}_${cleanName}`; 

            // B. الرفع إلى Supabase Storage Bucket
            const { data: storageData, error: storageError } = await supabaseClient.storage
                .from('mono_docs')
                .upload(filePath, file);

            if (storageError) throw storageError;

            // C. الحصول على الرابط العام المباشر للملف
            const { data: { publicUrl } } = supabaseClient.storage
                .from('mono_docs')
                .getPublicUrl(filePath);

            // D. حفظ معلومات الملف في قاعدة البيانات (Table)
            const { error: dbError } = await supabaseClient
                .from('pharmacy_docs')
                .insert([{
                    pharmacy_id: currentUser.id,
                    file_name: file.name,
                    file_url: publicUrl,
                    file_type: getFileType(file.name),
                    file_size: (file.size / 1024).toFixed(1) + ' KB',
                    storage_path: filePath
                }]);

            if (dbError) throw dbError;
        }

        // E. نجاح! إعادة تحميل القائمة من السيرفر
        await fetchDocsFromSupabase();

    } catch (error) {
        console.error('Upload Error:', error);
        showModal('Error', `<p style="text-align:center;">Upload Failed: ${error.message}</p>`, '<button class="btn-primary" onclick="closeModal()">OK</button>');
        container.innerHTML = originalContent; // استرجاع القائمة القديمة
    }
    
    input.value = ''; // تصفير حقل الإدخال
}

// 4. حذف ملف (من القاعدة والتخزين)
async function deleteDoc(id, storagePath) {
    if(!confirm('Are you sure you want to permanently delete this file?')) return;

    try {
        // A. حذف السجل من قاعدة البيانات
        const { error: dbError } = await supabaseClient
            .from('pharmacy_docs')
            .delete()
            .eq('id', id);

        if (dbError) throw dbError;

        // B. حذف الملف الفعلي من الـ Storage (لتوفير المساحة)
        if (storagePath) {
            await supabaseClient.storage.from('mono_docs').remove([storagePath]);
        }

        // تحديث الواجهة محلياً فوراً (للسرعة)
        storedFiles = storedFiles.filter(f => f.id !== id);
        renderDocsList();
        
        // تحديث العداد
        const titleEl = document.getElementById('docsModalTitle');
        if(titleEl) titleEl.textContent = `MY FILES (${storedFiles.length})`;

    } catch (error) {
        console.error('Delete Error:', error);
        alert('Failed to delete file from server');
    }
}

// 5. رسم المودال (الواجهة الرئيسية)
function renderDocsModal() {
    const content = `
        <div class="file-upload-area" onclick="document.getElementById('docsUploader').click()">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#B2BEC3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 10px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <div style="font-weight: 700; color: var(--primary);">Click to Upload Files</div>
            <div style="font-size: 11px; color: #999; margin-top: 5px;">PDF, Excel, TXT, Photos</div>
        </div>
        
        <div style="font-size: 12px; font-weight: 700; color: var(--dark); margin-bottom: 10px; display: flex; justify-content: space-between;">
            <span id="docsModalTitle">MY FILES (...)</span>
        </div>

        <div class="files-list-container" id="filesListRender">
            </div>
    `;

    showModal(
        '<span style="color: var(--primary);">📁 Documents Manager</span>',
        content,
        '<button class="btn-primary" onclick="closeModal()">Done</button>'
    );
}

// 6. رسم قائمة الملفات
function renderDocsList() {
    const container = document.getElementById('filesListRender');
    if (!container) return;

    if (storedFiles.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:30px 20px; color:#ccc;">
                <div style="font-size:30px; margin-bottom:10px; opacity:0.5;">☁️</div>
                No files stored yet.<br>Uploaded files will appear here.
            </div>`;
    } else {
        // إنشاء HTML لكل ملف
        container.innerHTML = storedFiles.map((file) => generateFileHTML(file)).join('');
    }
}
function generateFileHTML(file) {
    let icon = '';
    let typeClass = 'type-other';

    // تحديد الأيقونة واللون بناءً على النوع المسجل في الداتابيز
    if (file.file_type === 'pdf') { icon = 'PDF'; typeClass = 'type-pdf'; }
    else if (file.file_type === 'excel') { icon = 'XLS'; typeClass = 'type-excel'; }
    else if (file.file_type === 'img') { icon = 'IMG'; typeClass = 'type-img'; }
    else if (file.file_type === 'txt') { icon = 'TXT'; typeClass = 'type-txt'; }
    else { icon = 'DOC'; }

    // --- حساب الوقت المتبقي للحذف ---
    const createdDate = new Date(file.created_at);
    const expireDate = new Date(createdDate.getTime() + (24 * 60 * 60 * 1000)); // +24 ساعة
    const now = new Date();
    const diffMs = expireDate - now; // الفرق بالملي ثانية

    let expireText = '';
    
    if (diffMs > 0) {
        // تحويل الفرق لساعات ودقائق
        const hoursLeft = Math.floor(diffMs / (1000 * 60 * 60));
        const minsLeft = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        
        // تلوين النص حسب الوقت المتبقي (لو أقل من ساعة يبقى أحمر)
        const color = hoursLeft < 1 ? '#e74c3c' : '#27ae60';
        expireText = `<span style="font-size:10px; color:${color}; font-weight:bold; margin-left:5px;">(Expires in ${hoursLeft}h ${minsLeft}m)</span>`;
    } else {
        expireText = `<span style="font-size:10px; color:red; font-weight:bold; margin-left:5px;">(Expired)</span>`;
    }
    // --------------------------------

    return `
        <div class="file-item">
            <div class="file-info">
                <div class="file-icon ${typeClass}">${icon}</div>
                <div class="file-details">
                    <div class="file-name" title="${file.file_name}">
                        <a href="${file.file_url}" target="_blank" style="text-decoration:none; color:inherit;">${file.file_name}</a>
                    </div>
                    <div class="file-size">
                        ${file.file_size} ${expireText}
                    </div>
                </div>
            </div>
            <div class="file-actions">
                <button class="btn-icon-small btn-view" onclick="window.open('${file.file_url}', '_blank')" title="View">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
                
                <button class="btn-icon-small btn-share" onclick="shareDocWhatsApp('${file.file_url}', '${file.file_name}')" title="Share Link">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                </button>
                
                <button class="btn-icon-small btn-del" onclick="deleteDoc('${file.id}', '${file.storage_path}')" title="Delete">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        </div>
    `;
}
// 8. دالة مساعدة لتحديد نوع الملف
function getFileType(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'img';
    if (['pdf'].includes(ext)) return 'pdf';
    if (['xlsx', 'xls', 'csv'].includes(ext)) return 'excel';
    if (['txt'].includes(ext)) return 'txt';
    return 'other';
}

// 9. دالة المشاركة عبر واتساب (ترسل الرابط المباشر)
function shareDocWhatsApp(fileUrl, fileName) {
    // لأن الملف الآن مرفوع "أونلاين"، يمكننا إرسال الرابط مباشرة للطرف الآخر ليقوم بتحميله
    const text = `*Attached File:* ${fileName}\n*Download Link:* ${fileUrl}`;
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank');
}
function resetFilters() {
    // مسح التواريخ
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    
    // مسح شريط البحث
    document.getElementById('searchInput').value = '';
    
    // إلغاء فلترة التاريخ
    dateFilterActive = false;
    dateFilterFrom = null;
    dateFilterTo = null;
    
    // الرجوع لفلتر "All"
    currentFilter = 'all';
    
    // تحديث الـ Chips
    document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
    document.querySelectorAll('.chip')[0].classList.add('active'); // تفعيل "All"
    
    // إعادة عرض كل المرضى
    displayPatients();
}
// دالة لإرجاع Hex Color من اسم اللون
function getColorHex(colorName) {
    const colors = {
        'none': 'white',
        'green': '#4CAF50',
        'yellow': '#FFEB3B',
        'blue': '#2196F3',
        'red': '#F44336',
        'purple': '#9C27B0'
    };
    return colors[colorName] || 'white';
}

// فتح/إغلاق Color Picker
function toggleColorPicker(patientId, event) {
    event.stopPropagation();
    
    // إخفاء كل الـ Color Pickers المفتوحة
    document.querySelectorAll('.color-picker-dropdown').forEach(picker => {
        if (picker.id !== `color-picker-${patientId}`) {
            picker.classList.remove('active');
        }
    });
    
    // Toggle الـ Picker الحالي
    const picker = document.getElementById(`color-picker-${patientId}`);
    if (picker) {
        picker.classList.toggle('active');
    }
}

// تغيير لون الكارد
async function setCardColor(patientId, color) {
    const patient = dispensingQueue.find(p => String(p.id) === String(patientId));
    if (!patient) return;
    
    // تحديث اللون في الـ Array
    patient.cardColor = color;
    
    // إعادة رسم الجدول
    filterQueue();
    
    // حفظ في Supabase (اختياري)
    try {
        await supabaseClient
            .from('patients')
            .update({ cardcolor: color })
            .eq('id', patientId);
    } catch(err) {
        console.error('Failed to save color:', err);
    }
}

// إغلاق Color Picker عند الضغط خارجه
document.addEventListener('click', function(e) {
    if (!e.target.closest('.color-indicator') && !e.target.closest('.color-picker-dropdown')) {
        document.querySelectorAll('.color-picker-dropdown').forEach(picker => {
            picker.classList.remove('active');
        });
    }
});
// Toggle بين أبيض وأزرق فقط
async function toggleCardColor(patientId) {
    const patient = dispensingQueue.find(p => String(p.id) === String(patientId));
    if (!patient) return;
    
    // Toggle: لو أزرق خليه أبيض، لو أبيض خليه أزرق
    patient.cardColor = (patient.cardColor === 'blue') ? 'none' : 'blue';
    
    // إعادة رسم الجدول
    filterQueue();
    
    // حفظ في Supabase
    try {
        await supabaseClient
            .from('patients')
            .update({ cardcolor: patient.cardColor }) // ✅ cardcolor بدون underscore
            .eq('id', patientId);
        
        console.log(`✅ تم حفظ اللون: ${patientId} -> ${patient.cardColor}`);
    } catch(err) {
        console.error('❌ فشل حفظ اللون:', err);
    }
}
function forceUpdateTotal() {
    const totalCard = document.querySelector('.stat-card.total .number');
    if (totalCard) {
        totalCard.textContent = patients.length;
        console.log(`✅ Force updated total to: ${patients.length}`);
    } else {
        console.error('❌ Total card not found!');
    }
}
async function cleanExactDuplicates() {
    confirmAction('سيتم حذف الكروت التي لا تحتوي على رقم جوال، بشرط تطابقها تماماً في (الهوية، الوصفة، وتاريخ الريفيل) مع كارت آخر يحتوي على جوال. هل أنت متأكد؟', async function() {
        closeModal();
        
        console.log('🔍 Starting exact duplicate analysis...');

        // 1. تجميع البيانات بناءً على مفتاح فريد يجمع (الهوية + التاريخ)
        const groups = {};
        
        patients.forEach(p => {
            // تنظيف البيانات
            const id = p.nationalId.trim();
            const date = p.nextRefillDate ? p.nextRefillDate.split('T')[0] : 'NoDate';
            
            // إنشاء "بصمة" للوصفات (عشان نتأكد إنها نفس الوصفات بالظبط)
            // نرتب أرقام الوصفات ونجمعها في نص واحد
            const rxSignature = p.prescriptions
                .map(rx => rx.number.trim().toLowerCase())
                .sort()
                .join(',');

            // المفتاح الفريد للمقارنة
            const uniqueKey = `${id}|${date}|${rxSignature}`;

            if (!groups[uniqueKey]) groups[uniqueKey] = [];
            groups[uniqueKey].push(p);
        });

        const idsToDelete = [];

        // 2. فحص المجموعات
        for (const key in groups) {
            const group = groups[key];
            
            // إذا وجدنا أكثر من كارت بنفس البيانات (هوية + تاريخ + وصفات)
            if (group.length > 1) {
                
                // ترتيب المجموعة: 
                // الأول: الذي يحتوي على رقم جوال
                // الثاني: الأحدث تحديثاً
                group.sort((a, b) => {
                    const hasPhoneA = (a.phoneNumber && a.phoneNumber.length > 5) ? 1 : 0;
                    const hasPhoneB = (b.phoneNumber && b.phoneNumber.length > 5) ? 1 : 0;
                    
                    // الأولوية القصوى للي عنده رقم جوال
                    if (hasPhoneA !== hasPhoneB) {
                        return hasPhoneB - hasPhoneA; // (1) ييجي قبل (0)
                    }
                    
                    // لو الاتنين عندهم أو الاتنين معندهمش، نفضل الأحدث
                    return new Date(b.updatedAt) - new Date(a.updatedAt);
                });

                // أول واحد في القائمة هو "الأفضل" (اللي فيه جوال)
                const keeper = group[0];
                
                // الباقي هم "المكررين" (اللي مفيهمش جوال أو قدام)
                const duplicates = group.slice(1);
                
                // إضافة للماسح
                duplicates.forEach(dup => {
                    // شرط إضافي للتأكيد: نحذف فقط إذا كان الـ keeper عنده جوال والـ dup معندوش
                    // أو لو الاتنين زي بعض بالظبط بنحذف القديم
                    idsToDelete.push(dup.id);
                });
            }
        }

        if (idsToDelete.length === 0) {
            showModal('<span style="color:var(--secondary)">✅ نظيف</span>', '<p style="text-align:center; padding:20px;">لم يتم العثور على تكرار مطابق للشروط.</p>', '<button class="btn-primary" onclick="closeModal()">OK</button>');
            return;
        }

        // 3. التنفيذ والحذف
        try {
            console.log(`🗑️ Deleting ${idsToDelete.length} exact duplicates...`);
            
            const { error } = await supabaseClient
                .from('patients')
                .delete()
                .in('id', idsToDelete);

            if (error) throw error;

            // 4. تحديث العدادات محلياً
            patients = patients.filter(p => !idsToDelete.includes(p.id));
            
            // تحديث العداد الحقيقي
            if (typeof totalRealCount !== 'undefined') {
                totalRealCount -= idsToDelete.length;
            }

            updateStats();
            displayPatients();

            showModal(
                '<span style="color: var(--secondary);">✅ تم التنظيف</span>',
                `<p style="text-align:center; padding:20px;">
                    تم دمج وتنظيف <b>${idsToDelete.length}</b> كارت مكرر.<br>
                    <span style="font-size:12px; color:#666;">تم الإبقاء على الكروت التي تحتوي على أرقام جوال وحذف النسخ الفارغة المطابقة في التاريخ والوصفة.</span>
                </p>`,
                '<button class="btn-primary" onclick="closeModal()">OK</button>'
            );

        } catch (err) {
            console.error(err);
            showModal('<span style="color:var(--danger)">❌ خطأ</span>', '<p>حدث خطأ أثناء الحذف</p>', '<button class="btn-primary" onclick="closeModal()">OK</button>');
        }
    });
}
// متغير لتخزين الـ IDs المراد حذفها مؤقتاً
let pendingDeletionIds = [];

// ============================================
// 1. دالة الفحص والتقرير (CHECK & REPORT)
// ============================================
function checkExactDuplicatesReport() {
    console.log('🔍 Starting analysis...');
    
    const groups = {};
    
    // 1. تجميع البيانات بناءً على المفتاح الفريد (هوية + تاريخ + وصفات)
    patients.forEach(p => {
        const id = p.nationalId.trim();
        const date = p.nextRefillDate ? p.nextRefillDate.split('T')[0] : 'NoDate';
        
        // ترتيب الوصفات لضمان التطابق
        const rxSignature = p.prescriptions
            .map(rx => rx.number.trim().toLowerCase())
            .sort()
            .join(',');

        const uniqueKey = `${id}|${date}|${rxSignature}`;

        if (!groups[uniqueKey]) groups[uniqueKey] = [];
        groups[uniqueKey].push(p);
    });

    pendingDeletionIds = []; // تصفير القائمة
    let summaryHtml = '';
    let duplicateGroupsCount = 0;

    // 2. تحليل المكررات
    for (const key in groups) {
        const group = groups[key];
        
        if (group.length > 1) {
            // ترتيب المجموعة: الأفضلية للي عنده رقم جوال
            group.sort((a, b) => {
                const hasPhoneA = (a.phoneNumber && a.phoneNumber.length > 5) ? 1 : 0;
                const hasPhoneB = (b.phoneNumber && b.phoneNumber.length > 5) ? 1 : 0;
                
                // الأولوية القصوى للي عنده رقم جوال
                if (hasPhoneA !== hasPhoneB) return hasPhoneB - hasPhoneA;
                
                // لو الاتنين زي بعض، نفضل الأحدث
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });

            const keeper = group[0]; // سنحتفظ بهذا
            const duplicates = group.slice(1); // سنحذف هؤلاء
            
            // شرط: نحذف فقط إذا كان الـ keeper عنده جوال والـ duplicate معندوش
            // أو لو الاتنين معندهمش جوال بس متطابقين تماماً
            const validDuplicates = duplicates.filter(dup => {
                const keeperHasPhone = (keeper.phoneNumber && keeper.phoneNumber.length > 5);
                const dupHasPhone = (dup.phoneNumber && dup.phoneNumber.length > 5);
                
                // لو اللي هنمسحه عنده جوال واللي هنخليه معندوش -> لا تمسح (حماية)
                if (dupHasPhone && !keeperHasPhone) return false;
                
                return true;
            });

            if (validDuplicates.length > 0) {
                validDuplicates.forEach(d => pendingDeletionIds.push(d.id));
                duplicateGroupsCount++;

                // إضافة عينة للتقرير (أول 5 فقط عشان الشكل)
                if (duplicateGroupsCount <= 5) {
                    summaryHtml += `
                        <div style="background:white; padding:10px; margin-bottom:8px; border-radius:8px; border:1px solid #eee; font-size:11px; text-align:left;">
                            <div style="color:#2E7D32; font-weight:bold;">✅ Keep: ${keeper.nationalId} (Phone: ${keeper.phoneNumber || 'None'})</div>
                            ${validDuplicates.map(d => `<div style="color:#C62828;">❌ Delete: ID...${d.id.substr(0,4)} (Phone: ${d.phoneNumber || 'None'})</div>`).join('')}
                        </div>
                    `;
                }
            }
        }
    }

    // 3. عرض التقرير
    if (pendingDeletionIds.length === 0) {
        showModal(
            '<span style="color:var(--secondary)">✅ ممتاز</span>', 
            '<p style="text-align:center; padding:20px;">الداتا نظيفة! لا يوجد تكرار مطابق للشروط.</p>', 
            '<button class="btn-primary" onclick="closeModal()">OK</button>'
        );
    } else {
        showModal(
            '<span style="color:var(--warning)">⚠️ تقرير الحذف</span>',
            `
            <div style="padding:10px;">
                <p style="text-align:center; margin-bottom:15px; font-weight:bold; color:#2d3436;">
                    تم العثور على <span style="color:#e74c3c; font-size:18px;">${pendingDeletionIds.length}</span> كارت مكرر سيتم حذفه.
                </p>
                
                <div style="background:#F8F9FE; padding:10px; border-radius:10px; max-height:200px; overflow-y:auto; margin-bottom:15px;">
                    ${summaryHtml}
                    ${duplicateGroupsCount > 5 ? `<div style="text-align:center; color:#888; font-size:10px;">... and ${duplicateGroupsCount - 5} more groups.</div>` : ''}
                </div>

                <div style="background:#FFF3E0; padding:10px; border-radius:8px; font-size:11px; color:#E65100;">
                    💡 سيتم الحذف على دفعات لتجنب الأخطاء. هذه العملية لا يمكن التراجع عنها.
                </div>
            </div>
            `,
            `
            <button class="btn-secondary" onclick="closeModal()">إلغاء</button>
            <button class="btn-primary" onclick="executeBatchDeletion()" style="background: linear-gradient(135deg, #ff7675, #d63031);">تأكيد الحذف (${pendingDeletionIds.length})</button>
            `
        );
    }
}

// ============================================
// 2. دالة التنفيذ (الحذف على دفعات)
// ============================================
async function executeBatchDeletion() {
    const btn = document.querySelector('.modal-actions .btn-primary');
    if(btn) {
        btn.disabled = true;
        btn.textContent = 'جاري الحذف...';
    }

    try {
        console.log(`🚀 Starting batch deletion for ${pendingDeletionIds.length} items...`);
        
        // تقسيم الـ IDs إلى مجموعات (50 في كل مرة) عشان السيرفر ميقعش
        const BATCH_SIZE = 50; 
        const total = pendingDeletionIds.length;
        let deletedCount = 0;

        for (let i = 0; i < total; i += BATCH_SIZE) {
            const chunk = pendingDeletionIds.slice(i, i + BATCH_SIZE);
            
            // حذف الدفعة الحالية
            const { error } = await supabaseClient
                .from('patients')
                .delete()
                .in('id', chunk);

            if (error) {
                console.error('Error in batch:', error);
                // نكمل باقي الدفعات حتى لو دي فشلت
            } else {
                deletedCount += chunk.length;
                console.log(`✅ Deleted batch ${i/BATCH_SIZE + 1}`);
            }
        }

        // تحديث البيانات محلياً
        patients = patients.filter(p => !pendingDeletionIds.includes(p.id));
        
        if (typeof totalRealCount !== 'undefined') {
            totalRealCount -= deletedCount;
        }

        updateStats();
        displayPatients();

        showModal(
            '<span style="color: var(--secondary);">✅ تمت العملية</span>',
            `<div style="text-align:center; padding:20px;">
                <div style="font-size:40px;">🧹</div>
                <p style="margin-top:10px; font-weight:bold;">تم تنظيف ${deletedCount} كارت بنجاح.</p>
             </div>`,
            '<button class="btn-primary" onclick="closeModal()">OK</button>'
        );

    } catch (err) {
        console.error(err);
        showModal('<span style="color:var(--danger)">❌ خطأ</span>', `<p>حدث خطأ غير متوقع: ${err.message}</p>`, '<button class="btn-primary" onclick="closeModal()">OK</button>');
    }
}
    </script>
</body>
</html>

